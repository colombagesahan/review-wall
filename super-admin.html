<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Super Admin | God Mode</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body class="bg-gray-900 text-gray-100 font-sans" x-data="superAdmin()">

    <div class="container mx-auto p-6">
        <!-- Header -->
        <div class="flex justify-between items-center mb-10 border-b border-gray-700 pb-6">
            <div>
                <h1 class="text-3xl font-bold text-purple-500"><i class="fas fa-user-astronaut"></i> Super Admin</h1>
                <p class="text-gray-400">Manage AppSumo Agencies & Revenue</p>
            </div>
            <button @click="logout" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded text-sm">Logout</button>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <p class="text-gray-400 text-sm uppercase">Total Agencies</p>
                <p class="text-3xl font-bold mt-2" x-text="agencies.length">0</p>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <p class="text-gray-400 text-sm uppercase">LTD Revenue ($10/ea)</p>
                <p class="text-3xl font-bold mt-2 text-green-400" x-text="'$' + (agencies.length * 10)"></p>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                <p class="text-gray-400 text-sm uppercase">Total End Users</p>
                <p class="text-3xl font-bold mt-2 text-blue-400">Unknown</p> <!-- Requires extra query -->
            </div>
        </div>

        <!-- Agency Management Table -->
        <div class="bg-gray-800 rounded-xl border border-gray-700 overflow-hidden">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h2 class="text-xl font-bold">Registered Agencies</h2>
                <input type="text" placeholder="Search email..." class="bg-gray-900 border border-gray-600 px-4 py-2 rounded text-sm text-white">
            </div>
            <table class="w-full text-left">
                <thead class="bg-gray-900 text-gray-400 uppercase text-xs">
                    <tr>
                        <th class="p-4">Agency Email</th>
                        <th class="p-4">Plan Status</th>
                        <th class="p-4">Usage</th>
                        <th class="p-4">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700">
                    <template x-for="a in agencies">
                        <tr class="hover:bg-gray-750 transition">
                            <td class="p-4 font-bold" x-text="a.email"></td>
                            <td class="p-4">
                                <span class="px-2 py-1 rounded text-xs font-bold"
                                    :class="a.plan === 'pro_monthly' ? 'bg-purple-900 text-purple-200' : 'bg-blue-900 text-blue-200'"
                                    x-text="a.plan"></span>
                            </td>
                            <td class="p-4 text-sm">
                                <span x-text="a.userCount || 0"></span> / <span x-text="a.maxUsers"></span> Users
                            </td>
                            <td class="p-4">
                                <button @click="upgradeAgency(a.id)" class="text-green-400 hover:text-green-300 text-sm mr-3">
                                    <i class="fas fa-arrow-up"></i> Give Unlimited
                                </button>
                                <button @click="deleteAgency(a.id)" class="text-red-400 hover:text-red-300 text-sm">
                                    <i class="fas fa-trash"></i> Ban
                                </button>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        function superAdmin() {
            return {
                agencies: [],
                init() {
                    // Security: In real app, check if auth.currentUser.email == "your-email"
                    this.loadAgencies();
                },
                async loadAgencies() {
                    const snap = await db.collection('agencies').get();
                    // We also need to count users for each agency. This is expensive in NoSQL, 
                    // but fine for an MVP Admin panel.
                    this.agencies = await Promise.all(snap.docs.map(async doc => {
                        const data = doc.data();
                        const usersSnap = await db.collection('users').where('parentAgency', '==', doc.id).get();
                        return { id: doc.id, ...data, userCount: usersSnap.size };
                    }));
                },
                async upgradeAgency(id) {
                    if(confirm("Manually upgrade this agency to Unlimited (Monthly)?")) {
                        await db.collection('agencies').doc(id).update({ plan: 'pro_monthly', maxUsers: 999999 });
                        this.loadAgencies();
                    }
                },
                async deleteAgency(id) {
                    if(confirm("Ban this agency? This cannot be undone.")) {
                        await db.collection('agencies').doc(id).delete();
                        this.loadAgencies();
                    }
                },
                logout() { auth.signOut().then(() => window.location.href='index.html'); }
            }
        }
    </script>
</body>
</html>
