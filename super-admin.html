<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Super Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body class="bg-gray-900 text-gray-100 font-sans" x-data="adminPanel()">

    <div class="container mx-auto p-6 max-w-7xl">
        <div class="flex justify-between items-center mb-8 border-b border-gray-700 pb-4">
            <h1 class="text-3xl font-bold text-red-500"><i class="fas fa-shield-alt"></i> God Mode</h1>
            <div class="flex gap-4">
                <button @click="sendBroadcast = !sendBroadcast" class="bg-blue-600 px-4 py-2 rounded">üì¢ Send Alert</button>
                <button @click="auth.signOut()" class="bg-gray-700 px-4 py-2 rounded">Logout</button>
            </div>
        </div>

        <!-- BROADCAST MODAL -->
        <div x-show="sendBroadcast" class="bg-gray-800 p-6 rounded mb-8 border border-blue-500">
            <h2 class="text-xl font-bold mb-4">Send System Alert</h2>
            <textarea x-model="alertMsg" class="w-full bg-gray-900 p-3 rounded text-white border border-gray-600" placeholder="Message..."></textarea>
            <div class="flex gap-4 mt-4">
                <select x-model="alertTarget" class="bg-gray-900 p-2 rounded border border-gray-600">
                    <option value="all">Everyone</option>
                    <option value="agencies">Agencies</option>
                    <option value="clients">Clients</option>
                </select>
                <select x-model="alertType" class="bg-gray-900 p-2 rounded border border-gray-600">
                    <option value="info">Info (Blue)</option>
                    <option value="warning">Warning (Yellow)</option>
                    <option value="urgent">Urgent (Red)</option>
                </select>
                <button @click="sendAlert" class="bg-green-600 px-6 rounded font-bold">Send</button>
            </div>
        </div>

        <!-- FOLDERS / TABS -->
        <div class="flex gap-4 mb-6">
            <button @click="filter='open'" :class="filter=='open' ? 'bg-red-600' : 'bg-gray-800'" class="px-6 py-3 rounded font-bold">
                üö® New Disputes (<span x-text="disputes.filter(d => d.status === 'open').length"></span>)
            </button>
            <button @click="filter='warned'" :class="filter=='warned' ? 'bg-yellow-600' : 'bg-gray-800'" class="px-6 py-3 rounded font-bold">
                ‚ö†Ô∏è Warned Agencies
            </button>
            <button @click="filter='blocked'" :class="filter=='blocked' ? 'bg-gray-600' : 'bg-gray-800'" class="px-6 py-3 rounded font-bold">
                üö´ Blocked Agencies
            </button>
        </div>

        <!-- DISPUTE TABLE -->
        <div class="bg-gray-800 rounded-lg overflow-hidden border border-gray-700">
            <table class="w-full text-left text-sm">
                <thead class="bg-gray-900 text-gray-400">
                    <tr>
                        <th class="p-4">Reporter (Client)</th>
                        <th class="p-4">Accused (Agency)</th>
                        <th class="p-4">Issue</th>
                        <th class="p-4 text-right">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700">
                    <template x-for="d in filteredDisputes">
                        <tr class="hover:bg-gray-750">
                            <!-- Client Details -->
                            <td class="p-4">
                                <p class="font-bold text-white text-lg" x-text="d.clientName || 'Unknown Name'"></p>
                                <p class="text-blue-400" x-text="d.clientEmail"></p>
                                <p class="text-gray-500" x-text="d.clientPhone || 'No Phone'"></p>
                            </td>
                            <!-- Agency Details -->
                            <td class="p-4">
                                <p class="font-bold text-red-400" x-text="'ID: ' + d.agencyId"></p>
                                <p class="text-gray-500">Contact info requires fetch</p>
                            </td>
                            <!-- Issue -->
                            <td class="p-4">
                                <span class="bg-red-900 text-red-200 px-2 py-1 rounded text-xs">Payment Missing</span>
                                <p class="mt-1 text-2xl font-bold text-green-400" x-text="'$' + d.amount"></p>
                                <p class="text-xs text-gray-500" x-text="new Date(d.date.seconds*1000).toLocaleDateString()"></p>
                            </td>
                            <!-- Actions -->
                            <td class="p-4 text-right space-y-2">
                                
                                <div x-show="filter === 'open'">
                                    <button @click="updateStatus(d, 'warned', true)" class="bg-yellow-600 text-white px-3 py-1 rounded w-full hover:bg-yellow-500">Warn Agency</button>
                                    <button @click="updateStatus(d, 'blocked', true)" class="bg-red-600 text-white px-3 py-1 rounded w-full hover:bg-red-500 border border-red-400">BLOCK Agency</button>
                                </div>

                                <div x-show="filter === 'warned'">
                                    <button @click="updateStatus(d, 'open', false)" class="bg-green-700 text-white px-3 py-1 rounded w-full">Un-Warn (Restore)</button>
                                    <button @click="updateStatus(d, 'blocked', true)" class="bg-red-600 text-white px-3 py-1 rounded w-full">Escalate to BLOCK</button>
                                </div>

                                <div x-show="filter === 'blocked'">
                                    <button @click="updateStatus(d, 'open', false)" class="bg-gray-500 text-white px-3 py-1 rounded w-full">Un-Block</button>
                                </div>

                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
            <div x-show="filteredDisputes.length === 0" class="p-8 text-center text-gray-500">Folder is empty.</div>
        </div>

    </div>

    <script>
        function adminPanel() {
            return {
                disputes: [],
                filter: 'open', // open, warned, blocked
                sendBroadcast: false,
                alertMsg: '', alertTarget: 'all', alertType: 'info',

                init() {
                    const db = firebase.firestore();
                    db.collection('disputes').onSnapshot(snap => {
                        this.disputes = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    });
                },

                get filteredDisputes() {
                    return this.disputes.filter(d => d.status === this.filter);
                },

                async updateStatus(dispute, newStatus, isPunishment) {
                    const db = firebase.firestore();
                    
                    // 1. Update Dispute Folder
                    await db.collection('disputes').doc(dispute.id).update({ status: newStatus });

                    // 2. Update Agency Account Status
                    if (newStatus === 'warned') {
                        await db.collection('agencies').doc(dispute.agencyId).update({ warningStatus: true, blockedStatus: false });
                    } else if (newStatus === 'blocked') {
                        await db.collection('agencies').doc(dispute.agencyId).update({ warningStatus: true, blockedStatus: true });
                    } else if (newStatus === 'open') {
                        // Restore
                        await db.collection('agencies').doc(dispute.agencyId).update({ warningStatus: false, blockedStatus: false });
                    }
                },

                async sendAlert() {
                    const db = firebase.firestore();
                    await db.collection('alerts').add({
                        message: this.alertMsg,
                        target: this.alertTarget,
                        type: this.alertType,
                        sender: 'Super Admin',
                        createdAt: new Date()
                    });
                    this.sendBroadcast = false; this.alertMsg = '';
                    alert("Alert Sent!");
                }
            }
        }
    </script>
</body>
</html>
