<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Super Admin Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body class="bg-gray-900 text-gray-100 font-sans" x-data="adminPanel()">

    <div class="container mx-auto p-6 max-w-6xl">
        
        <!-- Header -->
        <div class="flex justify-between items-center mb-10 border-b border-gray-700 pb-4">
            <h1 class="text-3xl font-bold text-red-500"><i class="fas fa-shield-alt"></i> God Mode</h1>
            <div class="flex gap-4">
                <a href="index.html" class="text-gray-400 hover:text-white">Home</a>
                <button @click="auth.signOut()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">Logout</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <!-- SECTION 1: BROADCAST ALERTS -->
            <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                <h2 class="text-xl font-bold mb-4 text-blue-400">ðŸ“¢ Send System Alert</h2>
                <p class="text-gray-400 text-sm mb-4">Send a message to all Agencies or Clients dashboard.</p>
                
                <div class="space-y-4">
                    <textarea x-model="alertMsg" placeholder="Type your message here..." class="w-full bg-gray-900 border border-gray-600 rounded p-3 text-white h-24"></textarea>
                    
                    <div class="flex gap-4">
                        <select x-model="alertTarget" class="bg-gray-900 border border-gray-600 rounded p-2 text-white flex-1">
                            <option value="all">To Everyone</option>
                            <option value="agencies">To Agencies Only</option>
                            <option value="clients">To Clients Only</option>
                        </select>
                        <select x-model="alertType" class="bg-gray-900 border border-gray-600 rounded p-2 text-white flex-1">
                            <option value="info">Blue (Info)</option>
                            <option value="warning">Yellow (Warning)</option>
                            <option value="urgent">Red (Urgent)</option>
                        </select>
                    </div>

                    <button @click="sendAlert" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded">
                        Send Message
                    </button>
                </div>
            </div>

            <!-- SECTION 2: DISPUTE MANAGER -->
            <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                <h2 class="text-xl font-bold mb-4 text-red-400">ðŸš¨ Payment Disputes</h2>
                
                <div class="overflow-y-auto max-h-96">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-900 text-gray-400">
                            <tr>
                                <th class="p-3">Date</th>
                                <th class="p-3">Details</th>
                                <th class="p-3 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-700">
                            <template x-for="d in disputes">
                                <tr class="hover:bg-gray-750">
                                    <td class="p-3 text-gray-400" x-text="formatDate(d.date)"></td>
                                    <td class="p-3">
                                        <p class="font-bold text-white" x-text="d.clientEmail"></p>
                                        <p class="text-xs text-gray-500">Owed: <span class="text-green-400" x-text="'$' + d.amount"></span></p>
                                        <p class="text-xs text-red-400" x-text="'Agency ID: ' + d.agencyId"></p>
                                    </td>
                                    <td class="p-3 text-right space-y-2">
                                        <!-- WARN BUTTON -->
                                        <button @click="warnAgency(d.agencyId)" class="bg-yellow-600 text-white px-2 py-1 rounded text-xs block w-full hover:bg-yellow-500">
                                            Send Warning
                                        </button>
                                        <!-- REMOVE WARNING BUTTON -->
                                        <button @click="unwarnAgency(d.agencyId)" class="bg-green-700 text-white px-2 py-1 rounded text-xs block w-full hover:bg-green-600">
                                            Remove Warning
                                        </button>
                                        <!-- BAN BUTTON -->
                                        <button @click="banAgency(d.agencyId, d.id)" class="bg-red-600 text-white px-2 py-1 rounded text-xs block w-full hover:bg-red-500">
                                            Ban Agency
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    
                    <div x-show="disputes.length === 0" class="text-center py-10 text-gray-500">
                        No active disputes found.
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        function adminPanel() {
            return {
                disputes: [],
                alertMsg: '',
                alertTarget: 'all',
                alertType: 'info',

                init() {
                    // Connect to DB locally to load disputes
                    const db = firebase.firestore();
                    
                    db.collection('disputes').get().then(snap => {
                        this.disputes = snap.docs.map(d => ({id: d.id, ...d.data()}))
                            .sort((a,b) => b.date - a.date);
                    });
                },

                formatDate(timestamp) {
                    if(!timestamp) return 'N/A';
                    return new Date(timestamp.seconds * 1000).toLocaleDateString();
                },

                async sendAlert() {
                    if(!this.alertMsg) return;
                    const db = firebase.firestore(); // FIX: Define db inside function
                    
                    await db.collection('alerts').add({
                        message: this.alertMsg,
                        target: this.alertTarget,
                        type: this.alertType,
                        createdAt: new Date()
                    });
                    
                    this.alertMsg = '';
                    alert("Message Broadcasted Successfully!");
                },

                async warnAgency(id) {
                    const db = firebase.firestore(); // FIX: Define db inside function
                    try {
                        await db.collection('agencies').doc(id).update({ warningStatus: true });
                        alert("Warning sent! The Agency dashboard will now turn RED.");
                    } catch(e) {
                        alert("Error: " + e.message);
                    }
                },

                async unwarnAgency(id) {
                    const db = firebase.firestore(); // FIX: Define db inside function
                    try {
                        await db.collection('agencies').doc(id).update({ warningStatus: false });
                        alert("Warning removed. The Agency dashboard is normal again.");
                    } catch(e) {
                        alert("Error: " + e.message);
                    }
                },

                async banAgency(agencyId, disputeId) {
                    const db = firebase.firestore(); // FIX: Define db inside function
                    if(confirm("DANGER: This will delete the Agency account permanently. Continue?")) {
                        await db.collection('agencies').doc(agencyId).delete();
                        await db.collection('disputes').doc(disputeId).delete();
                        alert("Agency Banned/Deleted.");
                        window.location.reload();
                    }
                }
            }
        }
    </script>
</body>
</html>
