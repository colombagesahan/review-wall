<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Super Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body class="bg-gray-800 text-gray-100 p-8" x-data="adminApp()">

    <h1 class="text-3xl font-bold mb-8 text-red-500">Super Admin Control</h1>

    <!-- DISPUTES SECTION -->
    <div class="bg-gray-900 p-6 rounded-lg border border-gray-700 mb-8">
        <h2 class="text-xl font-bold mb-4">ðŸš¨ Payment Disputes</h2>
        <table class="w-full text-left text-sm">
            <thead class="bg-gray-800 text-gray-400">
                <tr><th>Date</th><th>Client</th><th>Agency ID</th><th>Amount</th><th>Actions</th></tr>
            </thead>
            <tbody>
                <template x-for="d in disputes">
                    <tr class="border-b border-gray-700">
                        <td class="p-3" x-text="new Date(d.date.seconds*1000).toLocaleDateString()"></td>
                        <td class="p-3" x-text="d.clientEmail"></td>
                        <td class="p-3 text-xs font-mono" x-text="d.agencyId"></td>
                        <td class="p-3 text-red-400" x-text="'$' + d.amount"></td>
                        <td class="p-3 flex gap-2">
                            <button @click="warnAgency(d.agencyId)" class="bg-yellow-600 px-3 py-1 rounded hover:bg-yellow-500">Warn Agency</button>
                            <button @click="banAgency(d.agencyId)" class="bg-red-600 px-3 py-1 rounded hover:bg-red-500">BAN AGENCY</button>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
        <div x-show="disputes.length === 0" class="text-gray-500 mt-2">No active disputes.</div>
    </div>

    <script>
        function adminApp() {
            return {
                disputes: [],
                init() {
                    // Load disputes
                    db.collection('disputes').where('status', '==', 'open').get().then(snap => {
                        this.disputes = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    });
                },
                async warnAgency(aid) {
                    await db.collection('agencies').doc(aid).update({ warningStatus: true });
                    alert("Red Warning sent to Agency Dashboard.");
                },
                async banAgency(aid) {
                    if(confirm("DELETE AGENCY? This is permanent.")) {
                        // 1. Delete Agency
                        await db.collection('agencies').doc(aid).delete();
                        // 2. Mark Users as Orphaned (Optional logic)
                        alert("Agency Banned. You can now reassign their clients manually in Firestore.");
                    }
                }
            }
        }
    </script>
</body>
</html>
