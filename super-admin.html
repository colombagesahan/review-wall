<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Super Admin Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body class="bg-gray-900 text-gray-100 font-sans" x-data="adminPanel()">

    <div class="container mx-auto p-6 max-w-6xl">
        <div class="flex justify-between items-center mb-10 border-b border-gray-700 pb-4">
            <h1 class="text-3xl font-bold text-red-500"><i class="fas fa-shield-alt"></i> God Mode</h1>
            <button @click="auth.signOut()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">Logout</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            
            <!-- SECTION 1: MESSAGING CENTER -->
            <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                <h2 class="text-xl font-bold mb-4 text-blue-400">ðŸ“¢ Message Center</h2>
                
                <div class="space-y-4">
                    <textarea x-model="alertMsg" placeholder="Type message..." class="w-full bg-gray-900 border border-gray-600 rounded p-3 text-white h-24"></textarea>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-gray-400">Who is this for?</label>
                            <select x-model="alertTarget" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white">
                                <option value="all">Global (Everyone)</option>
                                <option value="agencies">All Agencies</option>
                                <option value="clients">All Clients</option>
                                <option value="specific">Specific ID</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-xs text-gray-400">Color / Urgency</label>
                            <select x-model="alertType" class="w-full bg-gray-900 border border-gray-600 rounded p-2 text-white">
                                <option value="info">Blue (Info)</option>
                                <option value="warning">Yellow (Warning)</option>
                                <option value="urgent">Red (Urgent)</option>
                            </select>
                        </div>
                    </div>

                    <div x-show="alertTarget === 'specific'">
                        <input x-model="specificId" placeholder="Paste Agency ID or Client ID" class="w-full bg-gray-900 border border-blue-500 rounded p-2 text-white">
                    </div>

                    <button @click="sendAlert" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 rounded">Send Message</button>
                </div>
            </div>

            <!-- SECTION 2: DISPUTE MANAGER -->
            <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                <h2 class="text-xl font-bold mb-4 text-red-400">ðŸš¨ Disputes & Actions</h2>
                <div class="overflow-y-auto max-h-96">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-900 text-gray-400"><tr><th class="p-3">Details</th><th class="p-3 text-right">Action</th></tr></thead>
                        <tbody class="divide-y divide-gray-700">
                            <template x-for="d in disputes">
                                <tr class="hover:bg-gray-750">
                                    <td class="p-3">
                                        <p class="font-bold text-white" x-text="d.clientEmail"></p>
                                        <p class="text-xs text-gray-500">Reported: <span class="text-red-400" x-text="d.agencyId"></span></p>
                                        <p class="text-xs text-green-400" x-text="'Amount: $' + d.amount"></p>
                                    </td>
                                    <td class="p-3 text-right space-y-2">
                                        <button @click="warnAgency(d.agencyId)" class="bg-yellow-600 text-white px-2 py-1 rounded text-xs w-full hover:bg-yellow-500">Warn</button>
                                        <button @click="unwarnAgency(d.agencyId)" class="bg-green-700 text-white px-2 py-1 rounded text-xs w-full hover:bg-green-600">Un-Warn</button>
                                        <button @click="blockAgency(d.agencyId)" class="bg-red-700 text-white px-2 py-1 rounded text-xs w-full hover:bg-red-600 border border-red-500">BLOCK</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        function adminPanel() {
            return {
                disputes: [],
                alertMsg: '',
                alertTarget: 'all',
                specificId: '',
                alertType: 'info',

                init() {
                    const db = firebase.firestore();
                    db.collection('disputes').get().then(snap => {
                        this.disputes = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    });
                },

                async sendAlert() {
                    if(!this.alertMsg) return;
                    const db = firebase.firestore();
                    
                    let finalTarget = this.alertTarget;
                    if(this.alertTarget === 'specific') {
                        if(!this.specificId) { alert("Please enter an ID"); return; }
                        finalTarget = this.specificId; 
                    }
                    
                    await db.collection('alerts').add({
                        message: this.alertMsg,
                        target: finalTarget,
                        type: this.alertType,
                        sender: 'Super Admin', // Fixed Sender Name
                        createdAt: new Date()
                    });
                    
                    this.alertMsg = '';
                    this.specificId = '';
                    alert("Message Sent!");
                },

                // FIXED: Defined 'db' inside every function so it works 100%
                async warnAgency(id) {
                    const db = firebase.firestore();
                    await db.collection('agencies').doc(id).update({ warningStatus: true });
                    alert("Warning Sent.");
                },

                async unwarnAgency(id) {
                    const db = firebase.firestore();
                    await db.collection('agencies').doc(id).update({ warningStatus: false });
                    alert("Warning Removed.");
                },

                async blockAgency(id) {
                    if(confirm("BLOCK this Agency? They will lose access immediately.")) {
                        const db = firebase.firestore();
                        await db.collection('agencies').doc(id).update({ blockedStatus: true });
                        alert("Agency Blocked.");
                    }
                }
            }
        }
    </script>
</body>
</html>
