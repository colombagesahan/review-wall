<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Agency Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>

    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-100 font-sans" x-data="agencyApp()">

    <!-- SYSTEM ALERTS (Broadcasts) -->
    <template x-for="alert in systemAlerts">
        <div class="px-4 py-3 text-white text-center font-bold text-sm"
             :class="{
                'bg-blue-600': alert.type === 'info',
                'bg-yellow-500 text-black': alert.type === 'warning',
                'bg-red-600': alert.type === 'urgent'
             }">
            <span x-text="alert.message"></span>
        </div>
    </template>

    <div class="flex h-screen overflow-hidden">
        <div class="w-64 bg-slate-900 text-white flex flex-col p-4">
            <h1 class="text-2xl font-bold mb-8">Agency Admin</h1>
            
            <!-- DEBUG: Show ID to confirm matches Admin -->
            <p class="text-xs text-gray-500 mb-4 break-all">ID: <span x-text="uid"></span></p>

            <nav class="space-y-2">
                <a @click="tab='overview'" class="block p-3 rounded hover:bg-slate-800 cursor-pointer">Overview</a>
                <a @click="tab='clients'" class="block p-3 rounded hover:bg-slate-800 cursor-pointer">Clients & Payouts</a>
                <a @click="tab='settings'" class="block p-3 rounded hover:bg-slate-800 cursor-pointer">Payment Settings</a>
            </nav>
            <button @click="auth.signOut()" class="mt-auto text-gray-400">Logout</button>
        </div>

        <div class="flex-1 overflow-y-auto p-8">
            
            <!-- SUPER ADMIN WARNING (Real-time) -->
            <div x-show="warningStatus" x-cloak class="bg-red-600 text-white p-6 rounded-xl shadow-lg mb-8 animate-pulse border-4 border-red-800">
                <div class="flex items-center gap-4">
                    <i class="fas fa-exclamation-triangle text-4xl"></i>
                    <div>
                        <h2 class="text-2xl font-bold">URGENT: PAYMENT WARNING</h2>
                        <p class="mt-1 font-bold">The Super Admin has flagged your account for missing Client Payouts.</p>
                        <p class="text-sm opacity-90">Please pay your clients immediately to remove this warning and avoid a ban.</p>
                    </div>
                </div>
            </div>

            <div x-show="tab==='overview'">
                <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
                
                <div class="bg-white p-6 rounded shadow mb-6 border-l-4 border-blue-600">
                    <h3 class="font-bold text-lg mb-2">Your Promotional Website</h3>
                    <div class="flex gap-2">
                        <input readonly :value="promoLink" class="w-full bg-gray-100 border p-2 rounded text-sm">
                        <a :href="promoLink" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded font-bold">Open</a>
                    </div>
                </div>
            </div>

            <div x-show="tab==='clients'">
                <h2 class="text-3xl font-bold mb-6">Clients & Earnings</h2>
                <div class="bg-white rounded shadow overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50"><tr><th class="p-4">Client</th><th class="p-4">Unpaid Earnings</th><th class="p-4">Action</th></tr></thead>
                        <tbody>
                            <template x-for="c in clients">
                                <tr class="border-t">
                                    <td class="p-4" x-text="c.email"></td>
                                    <td class="p-4 font-bold text-green-600" x-text="'$' + (c.unpaidEarnings || 0)"></td>
                                    <td class="p-4">
                                        <button @click="markPaid(c)" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">Mark Paid</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <div x-show="tab==='settings'">
                <h2 class="text-3xl font-bold mb-6">Settings</h2>
                <div class="bg-white p-6 rounded shadow max-w-lg">
                    <label class="block font-bold mb-2">Agency Name</label>
                    <input x-model="agencyData.agencyName" class="w-full border p-3 rounded mb-4">
                    <label class="block font-bold mb-2">Payment Link</label>
                    <input x-model="agencyData.paymentLink" class="w-full border p-3 rounded mb-4">
                    <button @click="saveSettings" class="bg-slate-900 text-white px-6 py-2 rounded font-bold">Save Settings</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        function agencyApp() {
            return {
                tab: 'overview',
                uid: null,
                promoLink: '',
                clients: [],
                agencyData: { paymentLink: '', agencyName: '' },
                warningStatus: false, // Default false
                systemAlerts: [],

                init() {
                    auth.onAuthStateChanged(user => {
                        if(user) {
                            this.uid = user.uid;
                            const baseUrl = window.location.href.split('/').slice(0,-1).join('/');
                            this.promoLink = `${baseUrl}/agency-promo.html?id=${this.uid}`;
                            
                            // Load Data
                            this.listenToAgencyData(); // NEW: Real-time listener
                            this.loadClients();
                            this.loadAlerts();
                        } else window.location.href='index.html';
                    });
                },

                // === REAL-TIME LISTENER FOR WARNINGS ===
                listenToAgencyData() {
                    const db = firebase.firestore();
                    // .onSnapshot() listens for changes instantly
                    db.collection('agencies').doc(this.uid).onSnapshot(doc => {
                        if(doc.exists) {
                            this.agencyData = doc.data();
                            // Update warning status immediately when Admin changes it
                            this.warningStatus = doc.data().warningStatus === true; 
                        }
                    });
                },

                async loadClients() {
                    const db = firebase.firestore();
                    const snap = await db.collection('users').where('parentAgency', '==', this.uid).get();
                    this.clients = snap.docs.map(d => ({id: d.id, ...d.data()}));
                },

                async loadAlerts() {
                    const db = firebase.firestore();
                    const snap = await db.collection('alerts').get();
                    this.systemAlerts = snap.docs
                        .map(d => d.data())
                        .filter(a => a.target === 'all' || a.target === 'agencies')
                        .sort((a,b) => b.createdAt - a.createdAt)
                        .slice(0, 1);
                },

                async saveSettings() {
                    const db = firebase.firestore();
                    await db.collection('agencies').doc(this.uid).update(this.agencyData);
                    alert("Settings Saved!");
                },

                async markPaid(client) {
                    const db = firebase.firestore();
                    if(confirm("Mark paid?")) {
                        await db.collection('users').doc(client.id).update({ unpaidEarnings: 0 });
                        // Reload clients to show $0
                        this.loadClients();
                    }
                }
            }
        }
    </script>
</body>
</html>
