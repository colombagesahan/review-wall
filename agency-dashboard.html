<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Agency Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body class="bg-gray-100 font-sans" x-data="agencyApp()">

    <div class="flex h-screen overflow-hidden">
        <div class="w-64 bg-slate-900 text-white flex flex-col p-4">
            <h1 class="text-2xl font-bold mb-8">Agency Admin</h1>
            <nav class="space-y-2">
                <a @click="tab='overview'" class="block p-3 rounded hover:bg-slate-800 cursor-pointer">Overview</a>
                <a @click="tab='clients'" class="block p-3 rounded hover:bg-slate-800 cursor-pointer">Clients & Payouts</a>
                <a @click="tab='settings'" class="block p-3 rounded hover:bg-slate-800 cursor-pointer">Payment Settings</a>
            </nav>
            <button @click="auth.signOut()" class="mt-auto text-gray-400">Logout</button>
        </div>

        <div class="flex-1 overflow-y-auto p-8">
            
            <!-- SUPER ADMIN WARNING -->
            <div x-show="warningStatus" class="bg-red-600 text-white p-6 rounded-xl shadow-lg mb-8 animate-pulse">
                <h2 class="text-2xl font-bold"><i class="fas fa-exclamation-triangle"></i> URGENT: PAYMENT WARNING</h2>
                <p class="mt-2">Super Admin has flagged your account for missing Client Payouts. Please clear all dues immediately or your account will be banned and clients reassigned.</p>
            </div>

            <div x-show="tab==='overview'">
                <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
                
                <!-- Promo Link Card -->
                <div class="bg-white p-6 rounded shadow mb-6 border-l-4 border-blue-600">
                    <h3 class="font-bold text-lg mb-2">Your Promotional Website</h3>
                    <p class="text-gray-500 mb-4">Send this link to recruit new clients:</p>
                    <div class="flex gap-2">
                        <input readonly :value="promoLink" class="w-full bg-gray-100 border p-2 rounded text-sm">
                        <a :href="promoLink" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded font-bold">Open</a>
                    </div>
                </div>
            </div>

            <div x-show="tab==='clients'">
                <h2 class="text-3xl font-bold mb-6">Clients & Earnings</h2>
                <div class="bg-white rounded shadow overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50"><tr><th class="p-4">Client</th><th class="p-4">Unpaid Earnings</th><th class="p-4">Action</th></tr></thead>
                        <tbody>
                            <template x-for="c in clients">
                                <tr class="border-t">
                                    <td class="p-4" x-text="c.email"></td>
                                    <td class="p-4 font-bold text-green-600" x-text="'$' + (c.unpaidEarnings || 0)"></td>
                                    <td class="p-4">
                                        <button @click="markPaid(c)" class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">Mark Paid</button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <div x-show="tab==='settings'">
                <h2 class="text-3xl font-bold mb-6">Payment Settings</h2>
                <div class="bg-white p-6 rounded shadow max-w-lg">
                    <label class="block font-bold mb-2">Your PayPal/Payment URL</label>
                    <p class="text-sm text-gray-500 mb-2">This link will be used on ALL your client stores.</p>
                    <input x-model="agencyData.paymentLink" placeholder="https://paypal.me/youragency" class="w-full border p-3 rounded mb-4">
                    <label class="block font-bold mb-2">Agency Name</label>
                    <input x-model="agencyData.agencyName" class="w-full border p-3 rounded mb-4">
                    <button @click="saveSettings" class="bg-slate-900 text-white px-6 py-2 rounded font-bold">Save Settings</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        function agencyApp() {
            return {
                tab: 'overview',
                uid: null,
                promoLink: '',
                clients: [],
                agencyData: { paymentLink: '', agencyName: '' },
                warningStatus: false,

                init() {
                    auth.onAuthStateChanged(user => {
                        if(user) {
                            this.uid = user.uid;
                            // FIXED: Generates correct GitHub Pages link
                            const baseUrl = window.location.href.split('/').slice(0,-1).join('/');
                            this.promoLink = `${baseUrl}/agency-promo.html?id=${this.uid}`;
                            this.loadData();
                        } else window.location.href='index.html';
                    });
                },

                async loadData() {
                    const doc = await db.collection('agencies').doc(this.uid).get();
                    if(doc.exists) {
                        this.agencyData = doc.data();
                        this.warningStatus = doc.data().warningStatus || false;
                    }
                    const snap = await db.collection('users').where('parentAgency', '==', this.uid).get();
                    this.clients = snap.docs.map(d => ({id: d.id, ...d.data()}));
                },

                async saveSettings() {
                    await db.collection('agencies').doc(this.uid).update(this.agencyData);
                    alert("Settings Saved!");
                },

                async markPaid(client) {
                    if(confirm("Confirm you have paid $" + client.unpaidEarnings + " to this client?")) {
                        await db.collection('users').doc(client.id).update({ unpaidEarnings: 0 });
                        this.loadData();
                    }
                }
            }
        }
    </script>
</body>
</html>
