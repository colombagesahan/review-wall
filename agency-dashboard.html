<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Agency Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>[x-cloak] { display: none !important; }</style>
</head>
<body class="bg-gray-100 font-sans" x-data="agencyApp()">

    <!-- 1. BLOCKED SCREEN (Overlays everything if blocked) -->
    <div x-show="blockedStatus" x-cloak class="fixed inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center text-center p-8 text-white">
        <i class="fas fa-ban text-6xl text-red-500 mb-4"></i>
        <h1 class="text-4xl font-bold mb-2">Account Blocked</h1>
        <p class="text-xl text-gray-400 mb-8 max-w-lg">
            Your account has been suspended due to multiple reports regarding unpaid client earnings.
        </p>
        <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
            <p class="text-sm text-gray-400 mb-2">To appeal this decision, contact Admin:</p>
            <p class="text-xl font-bold text-blue-400">colombagesahan@gmail.com</p>
        </div>
        <button @click="auth.signOut()" class="mt-8 text-gray-500 hover:text-white underline">Logout</button>
    </div>

    <!-- 2. NORMAL DASHBOARD (Only shows if NOT blocked) -->
    <div x-show="!blockedStatus" class="flex h-screen overflow-hidden">
        
        <!-- SIDEBAR -->
        <div class="w-64 bg-slate-900 text-white flex flex-col p-4">
            <h1 class="text-2xl font-bold mb-8">Agency Admin</h1>
            <p class="text-xs text-gray-500 mb-4 break-all">ID: <span x-text="uid"></span></p>
            
            <nav class="space-y-2">
                <a @click="switchTab('overview')" class="block p-3 rounded hover:bg-slate-800 cursor-pointer" :class="{'bg-slate-800': tab==='overview'}">Overview</a>
                <a @click="switchTab('clients')" class="block p-3 rounded hover:bg-slate-800 cursor-pointer" :class="{'bg-slate-800': tab==='clients'}">Clients</a>
                
                <a @click="switchTab('messages')" class="flex justify-between items-center p-3 rounded hover:bg-slate-800 cursor-pointer" :class="{'bg-slate-800': tab==='messages'}">
                    <span>Messages</span>
                    <!-- NEW MESSAGE BADGE (Hides when tab selected) -->
                    <span x-show="unreadCount > 0" class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full" x-text="unreadCount"></span>
                </a>
            </nav>
            <button @click="auth.signOut()" class="mt-auto text-gray-400">Logout</button>
        </div>

        <!-- MAIN CONTENT -->
        <div class="flex-1 overflow-y-auto p-8 relative">
            
            <!-- FIXED: BEAUTIFUL TOP ALERT (Only shows latest 1) -->
            <template x-for="alert in systemAlerts">
                <div x-show="showAlert" class="mb-6 rounded-lg p-4 text-white shadow-lg flex justify-between items-center"
                     :class="{
                        'bg-blue-600': alert.type === 'info',
                        'bg-yellow-500 text-black': alert.type === 'warning',
                        'bg-red-600': alert.type === 'urgent'
                     }">
                    <div>
                        <span class="font-bold uppercase text-xs opacity-75 mr-2" x-text="alert.sender || 'System'"></span>
                        <span class="font-bold" x-text="alert.message"></span>
                    </div>
                    <button @click="showAlert = false" class="text-xl font-bold opacity-50 hover:opacity-100">&times;</button>
                </div>
            </template>

            <!-- WARNING BOX (Persistent) -->
            <div x-show="warningStatus" x-cloak class="bg-red-600 text-white p-6 rounded-xl shadow-lg mb-8 border-4 border-red-800">
                <h2 class="text-2xl font-bold">URGENT: PAYMENT WARNING</h2>
                <p>Super Admin has flagged your account. Please pay your clients immediately.</p>
            </div>

            <!-- TAB: OVERVIEW -->
            <div x-show="tab==='overview'">
                <h2 class="text-3xl font-bold mb-6">Overview</h2>
                <!-- PROMO LINK FIXED -->
                <div class="bg-white p-6 rounded shadow mb-6 border-l-4 border-blue-600">
                    <h3 class="font-bold text-lg mb-2">Your Promotional Website</h3>
                    <p class="text-sm text-gray-500 mb-2">Send this link to recruit clients:</p>
                    <div class="flex gap-2">
                        <input readonly :value="promoLink" class="w-full bg-gray-100 border p-2 rounded text-sm text-gray-600">
                        <a :href="promoLink" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700">Open</a>
                    </div>
                </div>
            </div>

            <!-- TAB: CLIENTS -->
            <div x-show="tab==='clients'">
                <h2 class="text-3xl font-bold mb-6">Clients</h2>
                <div class="bg-white rounded shadow overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50"><tr><th class="p-4">Client</th><th class="p-4">Unpaid</th><th class="p-4">Action</th></tr></thead>
                        <tbody>
                            <template x-for="c in clients">
                                <tr class="border-t">
                                    <td class="p-4" x-text="c.email"></td>
                                    <td class="p-4 font-bold text-green-600" x-text="'$' + (c.unpaidEarnings || 0)"></td>
                                    <td class="p-4"><button @click="markPaid(c)" class="bg-green-600 text-white px-3 py-1 rounded text-sm">Mark Paid</button></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: MESSAGES (Inbox) -->
            <div x-show="tab==='messages'">
                <h2 class="text-3xl font-bold mb-6">Message Center</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    
                    <!-- SEND -->
                    <div class="bg-white p-6 rounded shadow h-fit">
                        <h3 class="font-bold text-lg mb-4">Send Message</h3>
                        <textarea x-model="msgText" class="w-full border p-3 rounded mb-4 h-32" placeholder="Write to your clients..."></textarea>
                        <select x-model="msgTarget" class="w-full border p-3 rounded mb-4">
                            <option value="all_my_clients">All My Clients</option>
                            <template x-for="c in clients">
                                <option :value="c.id" x-text="c.email"></option>
                            </template>
                        </select>
                        <button @click="sendMessage" class="bg-blue-600 text-white px-6 py-2 rounded font-bold w-full">Send Message</button>
                    </div>

                    <!-- INBOX (Color Coded) -->
                    <div class="bg-white p-6 rounded shadow">
                        <h3 class="font-bold text-lg mb-4 flex justify-between">
                            Inbox <span class="text-gray-400 text-sm font-normal">Latest messages</span>
                        </h3>
                        <div class="space-y-3 h-96 overflow-y-auto pr-2">
                            <template x-for="m in myMessages">
                                <div class="p-4 border rounded-lg shadow-sm"
                                     :class="{
                                        'bg-blue-50 border-blue-200': m.type === 'info',
                                        'bg-yellow-50 border-yellow-200': m.type === 'warning',
                                        'bg-red-50 border-red-200': m.type === 'urgent'
                                     }">
                                    <div class="flex justify-between items-start mb-1">
                                        <!-- Sender Name Display -->
                                        <span class="font-bold text-sm" 
                                              :class="{
                                                  'text-blue-800': m.type === 'info',
                                                  'text-yellow-800': m.type === 'warning',
                                                  'text-red-800': m.type === 'urgent'
                                              }"
                                              x-text="m.sender || 'System'"></span>
                                        <span class="text-[10px] text-gray-500" x-text="m.createdAt ? new Date(m.createdAt.seconds*1000).toLocaleDateString() : 'Now'"></span>
                                    </div>
                                    <p class="text-sm text-gray-800" x-text="m.message"></p>
                                </div>
                            </template>
                            <div x-show="myMessages.length === 0" class="text-center text-gray-400 py-10">No messages found.</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        function agencyApp() {
            return {
                tab: 'overview',
                uid: null,
                promoLink: '',
                clients: [],
                systemAlerts: [],
                showAlert: true,
                myMessages: [],
                msgText: '',
                msgTarget: 'all_my_clients',
                warningStatus: false,
                blockedStatus: false, // NEW: For blocking
                unreadCount: 0, // NEW: For Badge

                init() {
                    auth.onAuthStateChanged(user => {
                        if(user) {
                            this.uid = user.uid;
                            const baseUrl = window.location.href.split('/').slice(0,-1).join('/');
                            this.promoLink = `${baseUrl}/agency-promo.html?id=${this.uid}`;
                            
                            this.listenData(); // Checks Block/Warn status
                            this.loadClients();
                            this.listenMessages();
                        } else window.location.href='index.html';
                    });
                },

                // Logic to clear badge when clicking messages
                switchTab(newTab) {
                    this.tab = newTab;
                    if(newTab === 'messages') {
                        this.unreadCount = 0;
                    }
                },

                listenData() {
                    const db = firebase.firestore();
                    db.collection('agencies').doc(this.uid).onSnapshot(doc => {
                        if(doc.exists) {
                            const data = doc.data();
                            this.warningStatus = data.warningStatus === true;
                            this.blockedStatus = data.blockedStatus === true; // UPDATES UI INSTANTLY
                        }
                    });
                },

                async loadClients() {
                    const db = firebase.firestore();
                    const snap = await db.collection('users').where('parentAgency', '==', this.uid).get();
                    this.clients = snap.docs.map(d => ({id: d.id, ...d.data()}));
                },

                listenMessages() {
                    const db = firebase.firestore();
                    db.collection('alerts')
                      .orderBy('createdAt', 'desc')
                      .limit(20)
                      .onSnapshot(snap => {
                        const allDocs = snap.docs.map(d => d.data());
                        
                        // 1. Top Banner (Latest 1 Broadcast)
                        const broadcasts = allDocs.filter(a => a.target === 'all' || a.target === 'agencies');
                        if(broadcasts.length > 0) this.systemAlerts = [broadcasts[0]];

                        // 2. Inbox (Private Messages)
                        // This filters messages sent specifically to ME
                        const inbox = allDocs.filter(a => a.target === this.uid);
                        
                        // Check if we got a new message to update badge
                        if(inbox.length > this.myMessages.length && this.tab !== 'messages') {
                            this.unreadCount = inbox.length - this.myMessages.length;
                        }
                        this.myMessages = inbox;
                    });
                },

                async sendMessage() {
                    if(!this.msgText) return;
                    const db = firebase.firestore();
                    
                    // Simple logic for sending
                    if(this.msgTarget === 'all_my_clients') {
                         await db.collection('alerts').add({
                            message: this.msgText,
                            target: 'broadcast_' + this.uid, 
                            sender: 'Agency Admin',
                            type: 'info',
                            createdAt: new Date()
                        });
                    } else {
                        await db.collection('alerts').add({
                            message: this.msgText,
                            target: this.msgTarget,
                            sender: 'Agency Admin',
                            type: 'info',
                            createdAt: new Date()
                        });
                    }
                    this.msgText = '';
                    alert("Sent!");
                },

                async markPaid(client) {
                    const db = firebase.firestore();
                    if(confirm("Mark paid?")) {
                        await db.collection('users').doc(client.id).update({ unpaidEarnings: 0 });
                        this.loadClients();
                    }
                }
            }
        }
    </script>
</body>
</html>
