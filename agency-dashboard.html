<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Agency Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>[x-cloak] { display: none !important; }</style>
</head>
<body class="bg-gray-100 font-sans" x-data="agencyApp()">

    <!-- 1. BLOCKED SCREEN -->
    <div x-show="blockedStatus" x-cloak class="fixed inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center text-center p-8 text-white">
        <h1 class="text-4xl font-bold mb-2 text-red-500">ACCOUNT BLOCKED</h1>
        <p>Your agency has been suspended by Super Admin.</p>
        <button @click="auth.signOut()" class="mt-8 underline">Logout</button>
    </div>

    <!-- 2. MAIN DASHBOARD -->
    <div x-show="!blockedStatus" class="flex h-screen overflow-hidden">
        
        <!-- SIDEBAR -->
        <div class="w-64 bg-slate-900 text-white flex flex-col shadow-2xl z-10">
            <!-- Platform Branding -->
            <div class="p-6 bg-slate-950 border-b border-slate-800">
                <h1 class="text-2xl font-extrabold tracking-tight text-blue-500">AgencyFlow</h1>
                <p class="text-[10px] text-gray-500 uppercase mt-1">Platform</p>
            </div>

            <!-- Agency Info -->
            <div class="p-4 border-b border-slate-800 bg-slate-800/50">
                <p class="font-bold text-white truncate" x-text="profile.agencyName || 'My Agency'"></p>
                <p class="text-[10px] text-gray-400 font-mono break-all mt-1">ID: <span x-text="uid"></span></p>
                <div class="mt-2 inline-block px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider"
                     :class="plan === 'unlimited' ? 'bg-purple-600 text-white' : 'bg-gray-600 text-gray-300'">
                    <span x-text="plan === 'unlimited' ? 'Unlimited Plan' : 'Free Plan (Max 10)'"></span>
                </div>
            </div>
            
            <!-- Menu -->
            <nav class="flex-1 p-2 space-y-1 overflow-y-auto">
                <a @click="switchTab('profile')" class="block p-3 rounded hover:bg-slate-800 cursor-pointer" :class="{'bg-blue-900': tab==='profile'}">
                    <i class="fas fa-id-card w-6 mr-2"></i> Agency Profile <span x-show="!isBasicProfileComplete" class="text-red-400 text-xs ml-2">●</span>
                </a>
                <a @click="switchTab('overview')" class="block p-3 rounded hover:bg-slate-800 cursor-pointer" :class="{'bg-slate-800': tab==='overview'}">
                    <i class="fas fa-globe w-6 mr-2"></i> My Promotional Website
                </a>
                <a @click="switchTab('clients')" class="block p-3 rounded hover:bg-slate-800 cursor-pointer" :class="{'bg-slate-800': tab==='clients'}">
                    <i class="fas fa-users w-6 mr-2"></i> Clients
                </a>
                <a @click="switchTab('settings')" class="block p-3 rounded hover:bg-slate-800 cursor-pointer" :class="{'bg-slate-800': tab==='settings'}">
                    <i class="fas fa-wallet w-6 mr-2"></i> Payments
                </a>
            </nav>
            <button @click="auth.signOut()" class="p-4 text-gray-400 hover:text-white text-sm border-t border-slate-800">Logout</button>
        </div>

        <!-- MAIN CONTENT -->
        <div class="flex-1 overflow-y-auto p-8 relative">
            
            <!-- Admin Alerts -->
            <template x-for="alert in systemAlerts">
                <div class="mb-4 rounded p-3 text-white text-sm font-bold flex justify-between items-center shadow"
                     :class="{'bg-blue-600': alert.type === 'info', 'bg-red-600': alert.type === 'urgent'}">
                    <span x-text="alert.sender + ': ' + alert.message"></span>
                    <button @click="closeAlert(alert)" class="text-white opacity-50 hover:opacity-100">&times;</button>
                </div>
            </template>

            <!-- Warning Box -->
            <div x-show="warningStatus" x-cloak class="bg-red-600 text-white p-6 rounded-xl shadow-lg mb-8 border-4 border-red-800 animate-pulse">
                <h2 class="text-2xl font-bold">URGENT: ACCOUNT FLAGGED</h2>
                <p>Super Admin has flagged your account. Please resolve outstanding payments immediately.</p>
            </div>

            <!-- ======================= -->
            <!-- TAB: AGENCY PROFILE     -->
            <!-- ======================= -->
            <div x-show="tab==='profile'">
                <h2 class="text-3xl font-bold mb-2">Agency Profile</h2>
                <p class="text-gray-500 mb-6">Complete Basic Details to unlock your website. Verify business for Unlimited.</p>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    
                    <!-- 1. BASIC DETAILS (REQUIRED) -->
                    <div class="bg-white p-6 rounded shadow border-t-4 border-blue-500 h-fit">
                        <h3 class="font-bold text-xl mb-4 flex items-center gap-2">
                            1. Basic Details 
                            <span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Required</span>
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Agency Name *</label>
                                <input x-model="profile.agencyName" class="w-full border p-2 rounded">
                            </div>
                            
                            <!-- Country Dropdown with Auto-Code -->
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Residence Country *</label>
                                <select x-model="profile.country" @change="updatePhoneCode" class="w-full border p-2 rounded bg-white">
                                    <option value="">Select Country</option>
                                    <option value="Sri Lanka">Sri Lanka</option>
                                    <option value="United States">United States</option>
                                    <option value="United Kingdom">United Kingdom</option>
                                    <option value="India">India</option>
                                    <option value="Canada">Canada</option>
                                    <option value="Australia">Australia</option>
                                    <option value="Germany">Germany</option>
                                    <option value="France">France</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Owner/Manager Name *</label>
                                <input x-model="profile.ownerName" class="w-full border p-2 rounded">
                            </div>
                            
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Phone (International) *</label>
                                <input x-model="profile.phone" class="w-full border p-2 rounded" placeholder="+94...">
                            </div>
                            
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">WhatsApp Number *</label>
                                <input x-model="profile.whatsapp" class="w-full border p-2 rounded" placeholder="+94...">
                            </div>
                            
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Email Address *</label>
                                <input x-model="profile.email" class="w-full border p-2 rounded bg-gray-100" readonly>
                            </div>
                            
                            <!-- LEGAL AGREEMENT -->
                            <div class="bg-gray-50 p-3 rounded border">
                                <label class="flex items-start gap-2 cursor-pointer">
                                    <input type="checkbox" x-model="profile.agreedLegal" class="mt-1">
                                    <span class="text-xs text-gray-600">
                                        I agree not to use this platform for scams or illegal activities. I will operate under my country's laws. 
                                        <a href="legal.html" target="_blank" class="text-blue-600 underline">Read Legal Terms</a>.
                                    </span>
                                </label>
                            </div>

                            <button @click="saveBasicProfile" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded">
                                Save Basic Profile
                            </button>
                            <p class="text-xs text-center text-gray-400 mt-2">Saving will unlock your Promotional Website.</p>
                        </div>
                    </div>

                    <!-- 2. VERIFICATION (REQUIRED FOR UNLIMITED) -->
                    <div class="bg-white p-6 rounded shadow border-t-4" :class="plan === 'unlimited' ? 'border-purple-500' : 'border-gray-300'">
                        <h3 class="font-bold text-xl mb-4 flex items-center gap-2">
                            2. Business Verification
                            <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">For Unlimited</span>
                        </h3>
                        
                        <div x-show="plan === 'unlimited'" class="bg-purple-100 text-purple-800 p-3 rounded mb-4 font-bold text-center">
                            ✅ You are on the Unlimited Plan
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Target Countries</label>
                                <input x-model="profile.targetCountries" class="w-full border p-2 rounded" placeholder="e.g. USA, UK, Global">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Agency Address</label>
                                <input x-model="profile.address" class="w-full border p-2 rounded">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Google Profile Link</label>
                                <input x-model="profile.gProfile" class="w-full border p-2 rounded" placeholder="https://...">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Google Map Code</label>
                                <input x-model="profile.gMap" class="w-full border p-2 rounded">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Social Media Links</label>
                                <input x-model="profile.socials" class="w-full border p-2 rounded" placeholder="FB, Insta, LinkedIn...">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-gray-500 uppercase">Upload BR Photo (Business Registration)</label>
                                <input type="file" id="brUpload" class="w-full border p-2 rounded text-sm">
                                <p class="text-[10px] text-gray-400 mt-1">Required for verification.</p>
                            </div>

                            <button x-show="plan !== 'unlimited'" @click="upgradePlan" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded flex justify-center items-center gap-2">
                                <i class="fas fa-crown"></i> Upgrade to Unlimited ($10/mo)
                            </button>
                            
                            <button x-show="plan === 'unlimited'" @click="saveFullProfile" class="w-full bg-gray-800 text-white py-2 rounded">
                                Update Details
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: PROMOTIONAL WEBSITE (Formerly Overview) -->
            <div x-show="tab==='overview'">
                <h2 class="text-3xl font-bold mb-6">My Promotional Website</h2>
                
                <!-- Limit Warning -->
                <div x-show="clientCount >= 10 && plan === 'free'" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6">
                    <p class="font-bold">Plan Limit Reached!</p>
                    <p>You have 10 clients. Please complete your profile and upgrade to add more.</p>
                    <button @click="tab='profile'" class="mt-2 underline font-bold">Go to Profile</button>
                </div>

                <!-- Promo Link (Hidden if profile incomplete) -->
                <div x-show="isBasicProfileComplete">
                    <div class="bg-white p-6 rounded shadow mb-6 border-l-4 border-blue-600">
                        <h3 class="font-bold text-lg mb-2">Your Website Link</h3>
                        <p class="text-sm text-gray-500 mb-2">Share this link to recruit clients:</p>
                        <div class="flex gap-2">
                            <input readonly :value="promoLink" class="w-full bg-gray-100 border p-2 rounded text-sm text-gray-600">
                            <a :href="promoLink" target="_blank" class="bg-blue-600 text-white px-4 py-2 rounded font-bold hover:bg-blue-700">Open</a>
                        </div>
                    </div>
                    <p class="text-green-600 font-bold">✅ Link Active</p>
                </div>

                <div x-show="!isBasicProfileComplete" class="bg-gray-200 p-10 text-center rounded-lg text-gray-500 border border-gray-300">
                    <i class="fas fa-lock text-5xl mb-4 text-gray-400"></i>
                    <h3 class="text-xl font-bold mb-2">Website Locked</h3>
                    <p class="mb-4">You must complete the <strong>Basic Profile</strong> (left side) to activate your website.</p>
                    <button @click="tab='profile'" class="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">Go to Profile</button>
                </div>
            </div>

            <!-- TAB: CLIENTS -->
            <div x-show="tab==='clients'">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-3xl font-bold">Clients</h2>
                    <span class="bg-gray-200 px-3 py-1 rounded font-bold text-sm">
                        Total: <span x-text="clientCount"></span> / <span x-text="plan === 'unlimited' ? '∞' : '10'"></span>
                    </span>
                </div>
                
                <div class="bg-white rounded shadow overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50"><tr><th class="p-4">Client</th><th class="p-4">Contact</th><th class="p-4">Unpaid</th><th class="p-4">Action</th></tr></thead>
                        <tbody>
                            <template x-for="c in clients">
                                <tr class="border-t">
                                    <td class="p-4">
                                        <p class="font-bold" x-text="c.fullName || 'No Name'"></p>
                                        <p class="text-xs text-gray-500" x-text="c.email"></p>
                                    </td>
                                    <td class="p-4" x-text="c.phone || '-'"></td>
                                    <td class="p-4 font-bold text-green-600" x-text="'$' + (c.unpaidEarnings || 0)"></td>
                                    <td class="p-4"><button @click="markPaid(c)" class="bg-green-600 text-white px-3 py-1 rounded text-xs">Mark Paid</button></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: SETTINGS (Payments) -->
            <div x-show="tab==='settings'">
                <h2 class="text-3xl font-bold mb-6">Payment Gateways</h2>
                <div class="bg-white p-6 rounded shadow max-w-lg space-y-4">
                    <p class="text-sm text-gray-500">Configure how your clients accept payments.</p>
                    <input x-model="paymentData.paypal" placeholder="PayPal Email" class="w-full border p-2 rounded">
                    <input x-model="paymentData.stripe" placeholder="Stripe Key" class="w-full border p-2 rounded">
                    <input x-model="paymentData.payhere" placeholder="PayHere Merchant ID" class="w-full border p-2 rounded">
                    <textarea x-model="paymentData.bank" placeholder="Bank Details" class="w-full border p-2 rounded" rows="3"></textarea>
                    <button @click="savePayments" class="bg-slate-900 text-white px-6 py-2 rounded w-full font-bold">Save Payment Methods</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        function agencyApp() {
            return {
                tab: 'profile', // Default to Profile so they see it first
                uid: null, promoLink: '',
                clients: [], clientCount: 0,
                systemAlerts: [], warningStatus: false, blockedStatus: false,
                
                // Profile & Plan
                plan: 'free', 
                profile: {
                    agencyName: '', country: '', ownerName: '', phone: '', whatsapp: '', email: '', agreedLegal: false,
                    targetCountries: '', address: '', gProfile: '', gMap: '', socials: '', brPhotoUrl: ''
                },
                isBasicProfileComplete: false,
                
                // Country Codes Map
                countryCodes: {
                    "Sri Lanka": "+94",
                    "United States": "+1",
                    "United Kingdom": "+44",
                    "India": "+91",
                    "Canada": "+1",
                    "Australia": "+61",
                    "Germany": "+49",
                    "France": "+33"
                },

                // Payment Settings
                paymentData: { paypal: '', stripe: '', payhere: '', bank: '' },

                init() {
                    auth.onAuthStateChanged(user => {
                        if(user) {
                            this.uid = user.uid;
                            this.profile.email = user.email; 
                            this.promoLink = window.location.href.split('/').slice(0,-1).join('/') + `/agency-promo.html?id=${this.uid}`;
                            
                            this.listenData();
                            this.loadClients();
                            this.listenMessages();
                        } else window.location.href='index.html';
                    });
                },

                switchTab(t) { this.tab = t; },

                updatePhoneCode() {
                    const code = this.countryCodes[this.profile.country] || "";
                    if(code) {
                        // Only add if not already there to prevent duplicates
                        if(!this.profile.phone.startsWith(code)) this.profile.phone = code + " ";
                        if(!this.profile.whatsapp.startsWith(code)) this.profile.whatsapp = code + " ";
                    }
                },

                listenData() {
                    const db = firebase.firestore();
                    db.collection('agencies').doc(this.uid).onSnapshot(doc => {
                        if(doc.exists) {
                            const data = doc.data();
                            this.warningStatus = data.warningStatus;
                            this.blockedStatus = data.blockedStatus;
                            this.plan = data.plan || 'free';
                            
                            if(data.paymentMethods) this.paymentData = data.paymentMethods;

                            if(data.profile) {
                                this.profile = { ...this.profile, ...data.profile };
                                this.checkBasicProfile();
                            }
                        }
                    });
                },

                checkBasicProfile() {
                    const p = this.profile;
                    // Check required fields
                    if(p.agencyName && p.country && p.ownerName && p.phone && p.whatsapp && p.agreedLegal) {
                        this.isBasicProfileComplete = true;
                    } else {
                        this.isBasicProfileComplete = false;
                    }
                },

                async loadClients() {
                    const db = firebase.firestore();
                    const snap = await db.collection('users').where('parentAgency', '==', this.uid).get();
                    this.clients = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    this.clientCount = this.clients.length;
                },

                listenMessages() {
                    const db = firebase.firestore();
                    db.collection('alerts').where('target', 'in', ['all', 'agencies', this.uid])
                      .orderBy('createdAt', 'desc').limit(5)
                      .onSnapshot(snap => {
                          this.systemAlerts = snap.docs.map(d => d.data());
                      });
                },

                // --- PROFILE FUNCTIONS ---
                async saveBasicProfile() {
                    const p = this.profile;
                    
                    // VALIDATION
                    if(!p.agencyName || !p.country || !p.ownerName || !p.phone || !p.whatsapp) {
                        return alert("Please fill all REQUIRED fields marked with *");
                    }
                    if(!p.agreedLegal) return alert("You must agree to the legal terms.");

                    // SAVE TO FIREBASE
                    try {
                        const db = firebase.firestore();
                        await db.collection('agencies').doc(this.uid).update({
                            agencyName: p.agencyName,
                            profile: this.profile
                        });
                        
                        this.isBasicProfileComplete = true;
                        alert("Basic Profile Saved! Redirecting to Website Link...");
                        
                        // AUTO-SWITCH TAB
                        this.tab = 'overview';
                        
                    } catch (e) {
                        console.error(e);
                        alert("Error saving profile: " + e.message);
                    }
                },

                async upgradePlan() {
                    // 1. Check Basic Profile First
                    if(!this.isBasicProfileComplete) {
                        return alert("Please complete Step 1: Basic Details first.");
                    }

                    // 2. Validate Verification Details
                    const p = this.profile;
                    if(!p.targetCountries || !p.address || !p.gProfile || !p.gMap || !p.socials) {
                        return alert("Please fill all Business Verification details to upgrade.");
                    }
                    
                    const fileInput = document.getElementById('brUpload');
                    if(fileInput.files.length === 0 && !p.brPhotoUrl) {
                        return alert("Please upload your Business Registration Photo.");
                    }

                    if(fileInput.files.length > 0) {
                        this.profile.brPhotoUrl = "uploaded_" + fileInput.files[0].name;
                    }

                    if(confirm("Opening Payment Gateway (Paddle)...\nPay $10/month for Unlimited Access?")) {
                        const db = firebase.firestore();
                        await db.collection('agencies').doc(this.uid).update({
                            plan: 'unlimited',
                            profile: this.profile
                        });
                        alert("Upgrade Successful! You now have unlimited clients.");
                    }
                },

                async saveFullProfile() {
                    const db = firebase.firestore();
                    await db.collection('agencies').doc(this.uid).update({ profile: this.profile });
                    alert("Profile Updated.");
                },

                async savePayments() {
                    const db = firebase.firestore();
                    await db.collection('agencies').doc(this.uid).update({ paymentMethods: this.paymentData });
                    alert("Payment Methods Saved!");
                },

                async markPaid(c) {
                    const db = firebase.firestore();
                    if(confirm("Mark paid?")) {
                        await db.collection('users').doc(c.id).update({ unpaidEarnings: 0 });
                        this.loadClients();
                    }
                },
                
                closeAlert(alertItem) {
                    this.systemAlerts = this.systemAlerts.filter(a => a !== alertItem);
                }
            }
        }
    </script>
</body>
</html>
