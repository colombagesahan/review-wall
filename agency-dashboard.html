<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Agency Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>[x-cloak] { display: none !important; }</style>
</head>
<body class="bg-gray-100 font-sans" x-data="agencyApp()">

    <!-- 1. BROADCAST ALERTS (Top Banner) -->
    <template x-for="alert in systemAlerts">
        <div class="px-4 py-3 text-white text-center font-bold text-sm"
             :class="{'bg-blue-600': alert.type === 'info','bg-red-600': alert.type === 'urgent'}">
            <span x-text="alert.sender + ': ' + alert.message"></span>
        </div>
    </template>

    <div class="flex h-screen overflow-hidden">
        <div class="w-64 bg-slate-900 text-white flex flex-col p-4">
            <h1 class="text-2xl font-bold mb-8">Agency Admin</h1>
            <p class="text-xs text-gray-500 mb-4 break-all">ID: <span x-text="uid"></span></p>
            <nav class="space-y-2">
                <a @click="tab='overview'" class="block p-3 rounded hover:bg-slate-800 cursor-pointer">Overview</a>
                <a @click="tab='clients'" class="block p-3 rounded hover:bg-slate-800 cursor-pointer">Clients</a>
                <a @click="tab='messages'" class="block p-3 rounded hover:bg-slate-800 cursor-pointer">Messages <span class="bg-red-500 text-xs px-2 rounded-full" x-show="myMessages.length > 0" x-text="myMessages.length"></span></a>
            </nav>
            <button @click="auth.signOut()" class="mt-auto text-gray-400">Logout</button>
        </div>

        <div class="flex-1 overflow-y-auto p-8">
            
            <!-- WARNING BOX -->
            <div x-show="warningStatus" x-cloak class="bg-red-600 text-white p-6 rounded-xl shadow-lg mb-8 border-4 border-red-800">
                <h2 class="text-2xl font-bold">URGENT: PAYMENT WARNING</h2>
                <p>Super Admin has flagged your account. Please pay your clients.</p>
            </div>

            <!-- OVERVIEW & CLIENTS TABS (Keep existing code logic here) -->
            <div x-show="tab==='overview'"> <h2 class="text-3xl font-bold mb-6">Overview</h2> <!-- Existing Overview Code --> </div>
            <div x-show="tab==='clients'"> <h2 class="text-3xl font-bold mb-6">Clients</h2> <!-- Existing Client Table --> </div>

            <!-- NEW: MESSAGES TAB -->
            <div x-show="tab==='messages'">
                <h2 class="text-3xl font-bold mb-6">Message Center</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- SEND MESSAGE -->
                    <div class="bg-white p-6 rounded shadow">
                        <h3 class="font-bold text-lg mb-4">Send Message</h3>
                        <textarea x-model="msgText" class="w-full border p-3 rounded mb-4 h-32" placeholder="Write to your clients..."></textarea>
                        
                        <label class="block text-sm font-bold mb-2">Recipient:</label>
                        <select x-model="msgTarget" class="w-full border p-3 rounded mb-4">
                            <option value="all_my_clients">All My Clients</option>
                            <template x-for="c in clients">
                                <option :value="c.id" x-text="c.email"></option>
                            </template>
                        </select>
                        <button @click="sendMessage" class="bg-blue-600 text-white px-6 py-2 rounded font-bold">Send</button>
                    </div>

                    <!-- INBOX -->
                    <div class="bg-white p-6 rounded shadow">
                        <h3 class="font-bold text-lg mb-4">Inbox</h3>
                        <div class="space-y-3 h-96 overflow-y-auto">
                            <template x-for="m in myMessages">
                                <div class="p-3 bg-gray-50 border rounded hover:bg-gray-100">
                                    <div class="flex justify-between">
                                        <span class="font-bold text-sm text-blue-600" x-text="m.sender"></span>
                                        <span class="text-xs text-gray-400" x-text="new Date(m.createdAt.seconds*1000).toLocaleDateString()"></span>
                                    </div>
                                    <p class="text-sm mt-1" x-text="m.message"></p>
                                </div>
                            </template>
                            <div x-show="myMessages.length === 0" class="text-gray-400 text-sm">No messages.</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        function agencyApp() {
            return {
                tab: 'messages',
                uid: null,
                clients: [],
                systemAlerts: [],
                myMessages: [], // Inbox
                msgText: '',
                msgTarget: 'all_my_clients',
                warningStatus: false,

                init() {
                    auth.onAuthStateChanged(user => {
                        if(user) {
                            this.uid = user.uid;
                            this.listenData();
                            this.loadClients();
                            this.listenMessages();
                        } else window.location.href='index.html';
                    });
                },

                // 1. Listen for Warnings
                listenData() {
                    const db = firebase.firestore();
                    db.collection('agencies').doc(this.uid).onSnapshot(doc => {
                        if(doc.exists) this.warningStatus = doc.data().warningStatus === true;
                    });
                },

                async loadClients() {
                    const db = firebase.firestore();
                    const snap = await db.collection('users').where('parentAgency', '==', this.uid).get();
                    this.clients = snap.docs.map(d => ({id: d.id, ...d.data()}));
                },

                // 2. Listen for Messages (Broadcasts OR Private)
                listenMessages() {
                    const db = firebase.firestore();
                    db.collection('alerts')
                      .orderBy('createdAt', 'desc')
                      .limit(20)
                      .onSnapshot(snap => {
                        const allDocs = snap.docs.map(d => d.data());
                        
                        // Top Banner Alerts (Global or All Agencies)
                        this.systemAlerts = allDocs.filter(a => a.target === 'all' || a.target === 'agencies');

                        // Inbox Messages (Specific to ME or From Clients)
                        // Note: In a real app, query filtering is better, but JS filtering is fine for MVP
                        this.myMessages = allDocs.filter(a => a.target === this.uid); 
                    });
                },

                async sendMessage() {
                    if(!this.msgText) return;
                    const db = firebase.firestore();
                    
                    // Sending to "All My Clients" or "Specific Client"
                    // If "All", we actually create a broadcast specific to this agency's ID logic
                    // But for simplicity, we will loop and send to individual if list is small, 
                    // OR set target='agency_clients_ID'. Let's do simple looping for Specific, and Tag for All.
                    
                    if(this.msgTarget === 'all_my_clients') {
                        // Advanced: Send one message tagged 'client_of_AGENCYID'
                        // Simplified: We will just save it with target = 'client_broadcast_' + this.uid
                        await db.collection('alerts').add({
                            message: this.msgText,
                            target: 'broadcast_' + this.uid, 
                            sender: 'Agency Admin',
                            type: 'info',
                            createdAt: new Date()
                        });
                    } else {
                        // Direct Message
                        await db.collection('alerts').add({
                            message: this.msgText,
                            target: this.msgTarget, // Client ID
                            sender: 'Agency Admin',
                            type: 'info',
                            createdAt: new Date()
                        });
                    }
                    
                    this.msgText = '';
                    alert("Sent!");
                }
            }
        }
    </script>
</body>
</html>
