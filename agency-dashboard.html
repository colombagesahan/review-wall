<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Agency Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>[x-cloak] { display: none !important; }</style>
</head>
<body class="bg-gray-100 font-sans" x-data="agencyApp()">

    <!-- 1. BLOCKED SCREEN -->
    <div x-show="blockedStatus" x-cloak class="fixed inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center text-center p-8 text-white">
        <h1 class="text-4xl font-bold mb-2 text-red-500">ACCOUNT BLOCKED</h1>
        <p>Your agency has been suspended by Super Admin.</p>
        <button @click="auth.signOut()" class="mt-8 underline">Logout</button>
    </div>

    <!-- 2. SUPER ADMIN ALERTS (Fixed Top Bar) -->
    <div class="fixed top-0 left-0 right-0 z-40">
        <template x-for="alert in adminAlerts">
            <div class="px-4 py-3 text-white text-center font-bold text-sm flex justify-between"
                 :class="{'bg-blue-600': alert.type === 'info', 'bg-red-600': alert.type === 'urgent' || alert.type === 'warning'}">
                <span x-text="alert.sender + ': ' + alert.message"></span>
                <button x-show="alert.type === 'info'" @click="closeAlert(alert)" class="text-white font-bold">&times;</button>
            </div>
        </template>
        <!-- Hard Warning -->
        <div x-show="warningStatus" class="bg-red-700 text-white text-center py-2 font-bold animate-pulse">
            ⚠️ WARNING: Your account is flagged for non-payment. Pay clients immediately.
        </div>
    </div>

    <!-- MAIN APP -->
    <div x-show="!blockedStatus" class="flex h-screen pt-12"> <!-- pt-12 for alert space -->
        
        <!-- SIDEBAR -->
        <div class="w-64 bg-slate-900 text-white flex flex-col p-4">
            <h1 class="text-2xl font-bold mb-8">Agency</h1>
            <nav class="space-y-2">
                <a @click="tab='overview'" class="block p-3 rounded hover:bg-slate-800 cursor-pointer">Overview</a>
                <a @click="tab='clients'" class="block p-3 rounded hover:bg-slate-800 cursor-pointer">Clients</a>
                <a @click="tab='orders'" class="block p-3 rounded hover:bg-slate-800 cursor-pointer">Orders</a>
                <a @click="tab='chat'" class="block p-3 rounded hover:bg-slate-800 cursor-pointer">Chat <span x-show="unreadCount > 0" class="bg-red-500 text-xs px-2 rounded-full" x-text="unreadCount"></span></a>
                <a @click="tab='settings'" class="block p-3 rounded hover:bg-slate-800 cursor-pointer">Payments</a>
            </nav>
            <button @click="auth.signOut()" class="mt-auto text-gray-400">Logout</button>
        </div>

        <div class="flex-1 overflow-y-auto p-8">

            <!-- TAB: OVERVIEW -->
            <div x-show="tab==='overview'">
                <h2 class="text-3xl font-bold mb-6">Overview</h2>
                <div class="bg-white p-6 rounded shadow border-l-4 border-blue-600">
                    <h3 class="font-bold text-lg mb-2">Recruitment Link</h3>
                    <input readonly :value="promoLink" class="w-full bg-gray-100 border p-2 rounded text-sm">
                </div>
            </div>

            <!-- TAB: CLIENTS -->
            <div x-show="tab==='clients'">
                <h2 class="text-3xl font-bold mb-6">Clients</h2>
                <div class="bg-white rounded shadow overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50"><tr><th class="p-4">Name/Email</th><th class="p-4">Phone</th><th class="p-4">Unpaid</th><th class="p-4">Action</th></tr></thead>
                        <tbody>
                            <template x-for="c in clients">
                                <tr class="border-t">
                                    <td class="p-4">
                                        <p class="font-bold" x-text="c.fullName || 'No Name'"></p>
                                        <p class="text-xs text-gray-500" x-text="c.email"></p>
                                    </td>
                                    <td class="p-4" x-text="c.phone || '-'"></td>
                                    <td class="p-4 font-bold text-green-600" x-text="'$' + (c.unpaidEarnings || 0)"></td>
                                    <td class="p-4"><button @click="markPaid(c)" class="bg-green-600 text-white px-3 py-1 rounded text-xs">Mark Paid</button></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- TAB: ORDERS (Mock) -->
            <div x-show="tab==='orders'">
                <h2 class="text-3xl font-bold mb-6">Orders</h2>
                <p class="text-gray-500">Orders from client stores will appear here.</p>
                <!-- Mock Order Table -->
                <div class="bg-white rounded shadow mt-4 p-4 text-center text-gray-400">No orders yet.</div>
            </div>

            <!-- TAB: CHAT (Real Messaging) -->
            <div x-show="tab==='chat'" class="h-[80vh] flex bg-white rounded shadow overflow-hidden">
                <!-- Chat List -->
                <div class="w-1/3 border-r overflow-y-auto">
                    <template x-for="c in clients">
                        <div @click="selectChat(c)" class="p-4 border-b hover:bg-gray-50 cursor-pointer" :class="activeChat?.id === c.id ? 'bg-blue-50' : ''">
                            <p class="font-bold text-sm" x-text="c.fullName || c.email"></p>
                            <p class="text-xs text-gray-400">Click to chat</p>
                        </div>
                    </template>
                </div>
                <!-- Chat View -->
                <div class="w-2/3 flex flex-col">
                    <div x-show="!activeChat" class="flex-1 flex items-center justify-center text-gray-400">Select a client to message</div>
                    <div x-show="activeChat" class="flex-1 flex flex-col">
                        <div class="p-4 border-b font-bold bg-gray-50" x-text="'Chat with ' + (activeChat?.fullName || 'Client')"></div>
                        <div class="flex-1 overflow-y-auto p-4 space-y-3" id="msgContainer">
                            <template x-for="m in currentMessages">
                                <div class="flex" :class="m.senderId === uid ? 'justify-end' : 'justify-start'">
                                    <div class="px-4 py-2 rounded-lg max-w-xs text-sm" 
                                         :class="m.senderId === uid ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-800'">
                                        <p x-text="m.text"></p>
                                        <p class="text-[10px] opacity-70" x-text="new Date(m.timestamp.seconds*1000).toLocaleTimeString()"></p>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div class="p-4 border-t flex gap-2">
                            <input x-model="chatInput" @keyup.enter="sendChat" class="flex-1 border p-2 rounded" placeholder="Type a message...">
                            <button @click="sendChat" class="bg-blue-600 text-white px-4 rounded">Send</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: PAYMENTS (Settings) -->
            <div x-show="tab==='settings'">
                <h2 class="text-3xl font-bold mb-6">Payment Gateways</h2>
                <div class="bg-white p-6 rounded shadow max-w-lg space-y-4">
                    <p class="text-sm text-gray-500">These details will be used on your clients' checkout pages.</p>
                    
                    <div>
                        <label class="font-bold text-sm">PayPal Email / Link</label>
                        <input x-model="paymentData.paypal" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="font-bold text-sm">Stripe Publishable Key</label>
                        <input x-model="paymentData.stripe" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="font-bold text-sm">PayHere Merchant ID</label>
                        <input x-model="paymentData.payhere" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="font-bold text-sm">Bank Transfer Instructions</label>
                        <textarea x-model="paymentData.bank" class="w-full border p-2 rounded" rows="3"></textarea>
                    </div>
                    
                    <button @click="savePayments" class="bg-slate-900 text-white px-6 py-2 rounded w-full font-bold">Save Payment Methods</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        function agencyApp() {
            return {
                tab: 'overview', uid: null,
                clients: [], adminAlerts: [], 
                warningStatus: false, blockedStatus: false,
                promoLink: '',
                // Payments
                paymentData: { paypal: '', stripe: '', payhere: '', bank: '' },
                // Chat
                activeChat: null, chatInput: '', currentMessages: [], unreadCount: 0,

                init() {
                    auth.onAuthStateChanged(user => {
                        if(user) {
                            this.uid = user.uid;
                            const baseUrl = window.location.href.split('/').slice(0,-1).join('/');
                            this.promoLink = `${baseUrl}/agency-promo.html?id=${this.uid}`;
                            
                            this.listenStatus();
                            this.loadClients();
                            this.listenAdminAlerts();
                            this.loadPaymentSettings();
                        } else window.location.href='index.html';
                    });
                },

                listenStatus() {
                    const db = firebase.firestore();
                    db.collection('agencies').doc(this.uid).onSnapshot(doc => {
                        if(doc.exists) {
                            this.warningStatus = doc.data().warningStatus;
                            this.blockedStatus = doc.data().blockedStatus;
                        }
                    });
                },

                async loadPaymentSettings() {
                    const db = firebase.firestore();
                    const doc = await db.collection('agencies').doc(this.uid).get();
                    if(doc.exists && doc.data().paymentMethods) {
                        this.paymentData = doc.data().paymentMethods;
                    }
                },

                async savePayments() {
                    const db = firebase.firestore();
                    await db.collection('agencies').doc(this.uid).update({ paymentMethods: this.paymentData });
                    alert("Payment Methods Saved!");
                },

                async loadClients() {
                    const db = firebase.firestore();
                    const snap = await db.collection('users').where('parentAgency', '==', this.uid).get();
                    this.clients = snap.docs.map(d => ({id: d.id, ...d.data()}));
                },

                listenAdminAlerts() {
                    const db = firebase.firestore();
                    db.collection('alerts').where('sender', '==', 'Super Admin')
                      .orderBy('createdAt', 'desc').limit(5)
                      .onSnapshot(snap => {
                          this.adminAlerts = snap.docs.map(d => d.data());
                      });
                },

                // CHAT LOGIC
                selectChat(client) {
                    this.activeChat = client;
                    const db = firebase.firestore();
                    // Listen for messages between Me (Agency) and This Client
                    // For MVP: Simplified query (Assuming a 'chatId' or simple filtering)
                    // We will query messages where (sender==me AND receiver==client) OR (sender==client AND receiver==me)
                    // Firestore OR queries are tricky. Let's filter client side for MVP or use a shared ID.
                    
                    db.collection('messages')
                      .orderBy('timestamp')
                      .onSnapshot(snap => {
                          const all = snap.docs.map(d => d.data());
                          this.currentMessages = all.filter(m => 
                              (m.senderId === this.uid && m.receiverId === client.id) ||
                              (m.senderId === client.id && m.receiverId === this.uid)
                          );
                          // Scroll to bottom
                          setTimeout(() => {
                              const el = document.getElementById('msgContainer');
                              if(el) el.scrollTop = el.scrollHeight;
                          }, 100);
                      });
                },

                async sendChat() {
                    if(!this.chatInput || !this.activeChat) return;
                    const db = firebase.firestore();
                    await db.collection('messages').add({
                        senderId: this.uid,
                        receiverId: this.activeChat.id,
                        text: this.chatInput,
                        timestamp: new Date()
                    });
                    this.chatInput = '';
                },

                async markPaid(c) {
                    const db = firebase.firestore();
                    if(confirm("Confirm payment?")) {
                        await db.collection('users').doc(c.id).update({ unpaidEarnings: 0 });
                        this.loadClients();
                    }
                }
            }
        }
    </script>
</body>
</html>
