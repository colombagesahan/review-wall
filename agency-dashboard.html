<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Agency Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
    <style>[x-cloak] { display: none !important; }</style>
</head>
<body class="bg-gray-100 font-sans" x-data="agencyApp()">

    <!-- 1. BLOCKED SCREEN -->
    <div x-show="blockedStatus" x-cloak class="fixed inset-0 bg-gray-900 z-50 flex flex-col items-center justify-center text-center p-8 text-white">
        <h1 class="text-4xl font-bold mb-2 text-red-500">ACCOUNT BLOCKED</h1>
        <p>Your agency has been suspended by Super Admin.</p>
        <button @click="auth.signOut()" class="mt-8 underline">Logout</button>
    </div>

    <!-- 2. NORMAL DASHBOARD -->
    <div x-show="!blockedStatus" class="flex h-screen overflow-hidden">
        
        <div class="w-64 bg-slate-900 text-white flex flex-col p-4">
            <h1 class="text-2xl font-bold mb-8">Agency Admin</h1>
            <p class="text-xs text-gray-500 mb-4 break-all">ID: <span x-text="uid"></span></p>
            <nav class="space-y-2">
                <a @click="switchTab('overview')" class="block p-3 rounded hover:bg-slate-800 cursor-pointer">Overview</a>
                <a @click="switchTab('clients')" class="block p-3 rounded hover:bg-slate-800 cursor-pointer">Clients</a>
                <a @click="switchTab('messages')" class="flex justify-between items-center p-3 rounded hover:bg-slate-800 cursor-pointer">
                    <span>Messages</span>
                    <span x-show="unreadCount > 0" class="bg-red-500 text-white text-xs px-2 py-0.5 rounded-full" x-text="unreadCount"></span>
                </a>
            </nav>
            <button @click="auth.signOut()" class="mt-auto text-gray-400">Logout</button>
        </div>

        <div class="flex-1 overflow-y-auto p-8 relative">
            
            <!-- ALERTS -->
            <template x-for="alert in systemAlerts">
                <div x-show="showAlert" class="mb-6 rounded-lg p-4 text-white shadow-lg flex justify-between items-center"
                     :class="{'bg-blue-600': alert.type === 'info', 'bg-red-600': alert.type === 'urgent'}">
                    <div>
                        <span class="font-bold uppercase text-xs opacity-75 mr-2" x-text="alert.sender || 'System'"></span>
                        <span class="font-bold" x-text="alert.message"></span>
                    </div>
                    <button @click="showAlert = false" class="text-xl font-bold opacity-50">&times;</button>
                </div>
            </template>

            <!-- WARNING BOX -->
            <div x-show="warningStatus" x-cloak class="bg-red-600 text-white p-6 rounded-xl shadow-lg mb-8 border-4 border-red-800">
                <h2 class="text-2xl font-bold">URGENT: PAYMENT WARNING</h2>
                <p>Super Admin has flagged your account. Please pay your clients immediately.</p>
            </div>

            <div x-show="tab==='overview'">
                <h2 class="text-3xl font-bold mb-6">Overview</h2>
                <div class="bg-white p-6 rounded shadow mb-6 border-l-4 border-blue-600">
                    <h3 class="font-bold text-lg mb-2">Recruitment Link</h3>
                    <input readonly :value="promoLink" class="w-full bg-gray-100 border p-2 rounded text-sm">
                </div>
            </div>

            <div x-show="tab==='clients'">
                <h2 class="text-3xl font-bold mb-6">Clients</h2>
                <div class="bg-white rounded shadow overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-gray-50"><tr><th class="p-4">Client</th><th class="p-4">Unpaid</th><th class="p-4">Action</th></tr></thead>
                        <tbody>
                            <template x-for="c in clients">
                                <tr class="border-t">
                                    <td class="p-4" x-text="c.email"></td>
                                    <td class="p-4 font-bold text-green-600" x-text="'$' + (c.unpaidEarnings || 0)"></td>
                                    <td class="p-4"><button @click="markPaid(c)" class="bg-green-600 text-white px-3 py-1 rounded text-sm">Mark Paid</button></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

            <div x-show="tab==='messages'">
                <h2 class="text-3xl font-bold mb-6">Message Center</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- SEND -->
                    <div class="bg-white p-6 rounded shadow h-fit">
                        <h3 class="font-bold text-lg mb-4">Send Message</h3>
                        <textarea x-model="msgText" class="w-full border p-3 rounded mb-4 h-32"></textarea>
                        <select x-model="msgTarget" class="w-full border p-3 rounded mb-4">
                            <option value="all_my_clients">All My Clients</option>
                            <template x-for="c in clients"><option :value="c.id" x-text="c.email"></option></template>
                        </select>
                        <button @click="sendMessage" class="bg-blue-600 text-white px-6 py-2 rounded font-bold w-full">Send Message</button>
                    </div>
                    <!-- INBOX -->
                    <div class="bg-white p-6 rounded shadow">
                        <h3 class="font-bold text-lg mb-4">Inbox</h3>
                        <div class="space-y-3 h-96 overflow-y-auto pr-2">
                            <template x-for="m in myMessages">
                                <div class="p-4 border rounded-lg shadow-sm" :class="{'bg-blue-50': m.type==='info', 'bg-red-50': m.type==='urgent'}">
                                    <div class="flex justify-between items-start mb-1">
                                        <span class="font-bold text-sm" x-text="m.sender || 'System'"></span>
                                    </div>
                                    <p class="text-sm text-gray-800" x-text="m.message"></p>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        function agencyApp() {
            return {
                tab: 'overview', uid: null, promoLink: '',
                clients: [], systemAlerts: [], showAlert: true, myMessages: [],
                msgText: '', msgTarget: 'all_my_clients', warningStatus: false, blockedStatus: false, unreadCount: 0,

                init() {
                    auth.onAuthStateChanged(user => {
                        if(user) {
                            this.uid = user.uid;
                            this.promoLink = window.location.href.split('/').slice(0,-1).join('/') + `/agency-promo.html?id=${this.uid}`;
                            this.listenData(); this.loadClients(); this.listenMessages();
                        } else window.location.href='index.html';
                    });
                },

                switchTab(newTab) {
                    this.tab = newTab;
                    if(newTab === 'messages') this.unreadCount = 0;
                },

                listenData() {
                    firebase.firestore().collection('agencies').doc(this.uid).onSnapshot(doc => {
                        if(doc.exists) {
                            this.warningStatus = doc.data().warningStatus;
                            this.blockedStatus = doc.data().blockedStatus;
                        }
                    });
                },

                async loadClients() {
                    const snap = await firebase.firestore().collection('users').where('parentAgency', '==', this.uid).get();
                    this.clients = snap.docs.map(d => ({id: d.id, ...d.data()}));
                },

                listenMessages() {
                    firebase.firestore().collection('alerts').orderBy('createdAt', 'desc').limit(20).onSnapshot(snap => {
                        const allDocs = snap.docs.map(d => d.data());
                        const broadcasts = allDocs.filter(a => a.target === 'all' || a.target === 'agencies');
                        if(broadcasts.length > 0) this.systemAlerts = [broadcasts[0]];
                        
                        const inbox = allDocs.filter(a => a.target === this.uid);
                        if(inbox.length > this.myMessages.length && this.tab !== 'messages') this.unreadCount = inbox.length - this.myMessages.length;
                        this.myMessages = inbox;
                    });
                },

                async sendMessage() {
                    if(!this.msgText) return;
                    const db = firebase.firestore();
                    const target = this.msgTarget === 'all_my_clients' ? 'broadcast_' + this.uid : this.msgTarget;
                    await db.collection('alerts').add({
                        message: this.msgText, target: target, sender: 'Agency Admin', type: 'info', createdAt: new Date()
                    });
                    this.msgText = ''; alert("Sent!");
                },

                async markPaid(client) {
                    if(confirm("Mark paid?")) {
                        await firebase.firestore().collection('users').doc(client.id).update({ unpaidEarnings: 0 });
                        this.loadClients();
                    }
                }
            }
        }
    </script>
</body>
</html>
