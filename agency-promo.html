<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Join Our Agency</title>
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    
    <!-- FIREBASE SCRIPTS (Order is Important) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script> <!-- THIS WAS MISSING -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <!-- Your Config -->
    <script src="firebase-config.js"></script>
</head>
<body class="bg-white text-gray-800" x-data="promoPage()">

    <!-- Loading Screen -->
    <div x-show="loading" class="h-screen flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-4"></div>
        <p class="text-gray-500">Loading Agency Details...</p>
    </div>

    <!-- Error Screen -->
    <div x-show="!loading && !valid" class="h-screen flex flex-col items-center justify-center text-center px-4" style="display: none;">
        <h1 class="text-3xl font-bold text-gray-400 mb-2">Agency Not Found</h1>
        <p class="text-gray-500 mb-6" x-text="errorMessage">Please check the link and try again.</p>
        <a href="index.html" class="text-blue-600 underline">Go to Home</a>
    </div>

    <!-- Main Content -->
    <div x-show="!loading && valid" style="display: none;">
        <!-- Agency Hero -->
        <header class="bg-gray-900 text-white py-24 text-center px-4">
            <h1 class="text-5xl font-bold mb-4" x-text="data.agencyName"></h1>
            <p class="text-xl text-gray-400 mb-8 max-w-2xl mx-auto">
                Join our exclusive dropshipping network. We provide the products, you make the sales.
            </p>
            <button @click="joinNow" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-8 rounded-full shadow-lg transition transform hover:scale-105">
                Start Selling Today
            </button>
        </header>

        <section class="container mx-auto py-16 px-6 grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
            <div class="p-6 border rounded-xl shadow-sm hover:shadow-md transition">
                <div class="text-4xl text-blue-500 mb-4">ðŸ“¦</div>
                <h3 class="font-bold text-xl mb-2">Premium Products</h3>
                <p class="text-gray-500">Access our curated catalog of high-converting items.</p>
            </div>
            <div class="p-6 border rounded-xl shadow-sm hover:shadow-md transition">
                <div class="text-4xl text-purple-500 mb-4">ðŸš€</div>
                <h3 class="font-bold text-xl mb-2">Instant Store</h3>
                <p class="text-gray-500">Get your own ecommerce website generated instantly.</p>
            </div>
            <div class="p-6 border rounded-xl shadow-sm hover:shadow-md transition">
                <div class="text-4xl text-green-500 mb-4">ðŸ’¸</div>
                <h3 class="font-bold text-xl mb-2">Fast Payouts</h3>
                <p class="text-gray-500">We handle the supply chain. You focus on selling.</p>
            </div>
        </section>
    </div>

    <script>
        function promoPage() {
            return {
                loading: true,
                valid: false,
                aid: null,
                data: { agencyName: 'Loading...' },
                errorMessage: 'The link might be broken or the agency does not exist.',

                async init() {
                    try {
                        const params = new URLSearchParams(window.location.search);
                        this.aid = params.get('id');

                        if(!this.aid) {
                            throw new Error("No Agency ID in URL");
                        }

                        // Use global 'db' from window
                        const doc = await window.db.collection('agencies').doc(this.aid).get();
                        
                        if(doc.exists) {
                            this.data = doc.data();
                            this.valid = true;
                            document.title = "Join " + (this.data.agencyName || "Agency");
                        } else {
                            this.errorMessage = "This Agency ID does not exist in our database.";
                        }
                    } catch (e) {
                        console.error(e);
                        if(e.code === 'permission-denied') {
                            this.errorMessage = "Security Error: Please update Firestore Rules to allow 'read: true' for agencies.";
                        } else {
                            this.errorMessage = e.message;
                        }
                    } finally {
                        this.loading = false;
                    }
                },

                joinNow() {
                    // Navigate to Index with REF code
                    const baseUrl = window.location.href.split('/').slice(0,-1).join('/');
                    window.location.href = `${baseUrl}/index.html?ref=${this.aid}`;
                }
            }
        }
    </script>
</body>
</html>
