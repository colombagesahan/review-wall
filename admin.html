<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Agency Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body class="bg-gray-100" x-data="adminPanel()">

    <div class="flex h-screen overflow-hidden">
        
        <!-- Sidebar -->
        <div class="w-64 bg-slate-900 text-white flex flex-col">
            <div class="p-6 text-xl font-bold tracking-wide border-b border-slate-800">AgencyFlow</div>
            <nav class="flex-1 p-4 space-y-2">
                <a @click="tab = 'dash'" :class="tab==='dash' ? 'bg-blue-600' : 'hover:bg-slate-800'" class="block p-3 rounded cursor-pointer"><i class="fas fa-home mr-2"></i> Dashboard</a>
                <a @click="tab = 'products'" :class="tab==='products' ? 'bg-blue-600' : 'hover:bg-slate-800'" class="block p-3 rounded cursor-pointer"><i class="fas fa-box mr-2"></i> Products</a>
                <a @click="tab = 'design'" :class="tab==='design' ? 'bg-blue-600' : 'hover:bg-slate-800'" class="block p-3 rounded cursor-pointer"><i class="fas fa-paint-brush mr-2"></i> Design</a>
            </nav>
            <div class="p-4 border-t border-slate-800">
                <button @click="logout" class="text-gray-400 hover:text-white text-sm">Sign Out</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 overflow-y-auto p-8">
            
            <!-- Dashboard Tab -->
            <div x-show="tab === 'dash'">
                <h2 class="text-3xl font-bold mb-6">Overview</h2>
                
                <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                    <h3 class="font-bold text-gray-500 text-sm uppercase mb-2">Your Public Store Link</h3>
                    <div class="flex gap-2">
                        <input type="text" readonly :value="storeLink" class="flex-1 bg-gray-100 p-3 rounded border">
                        <a :href="storeLink" target="_blank" class="bg-green-600 text-white px-6 py-3 rounded font-bold hover:bg-green-700">Open Store</a>
                    </div>
                    <p class="text-xs text-gray-400 mt-2">Share this link with your customers.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded shadow border-l-4 border-blue-500">
                        <div class="text-gray-500">Total Products</div>
                        <div class="text-3xl font-bold" x-text="products.length">0</div>
                    </div>
                    <div class="bg-white p-6 rounded shadow border-l-4 border-purple-500">
                        <div class="text-gray-500">Plan</div>
                        <div class="text-xl font-bold text-green-600">Lifetime Pro</div>
                    </div>
                </div>
            </div>

            <!-- Products Tab -->
            <div x-show="tab === 'products'">
                <h2 class="text-3xl font-bold mb-6">Manage Inventory</h2>
                
                <div class="bg-white p-6 rounded shadow mb-6">
                    <h3 class="font-bold mb-4">Add New Product</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <input x-model="newProd.name" placeholder="Product Name" class="border p-2 rounded">
                        <input x-model="newProd.price" type="number" placeholder="Price" class="border p-2 rounded">
                        <input x-model="newProd.image" placeholder="Image URL" class="border p-2 rounded col-span-2">
                    </div>
                    <button @click="addProduct" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Add Product</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <template x-for="p in products">
                        <div class="bg-white rounded shadow p-4 relative">
                            <img :src="p.image" class="w-full h-32 object-cover rounded mb-2 bg-gray-200">
                            <h4 class="font-bold" x-text="p.name"></h4>
                            <p class="text-blue-600 font-bold" x-text="'$' + p.price"></p>
                            <button @click="deleteProduct(p.id)" class="text-red-500 text-sm mt-2">Remove</button>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Design Tab -->
            <div x-show="tab === 'design'">
                <h2 class="text-3xl font-bold mb-6">Store Appearance</h2>
                <div class="bg-white p-6 rounded shadow max-w-xl">
                    <div class="space-y-4">
                        <div>
                            <label class="block font-bold mb-1">Store Name</label>
                            <input x-model="settings.name" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block font-bold mb-1">Hero Banner Text</label>
                            <input x-model="settings.heroText" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block font-bold mb-1">Brand Color</label>
                            <input type="color" x-model="settings.color" class="w-full h-10 rounded cursor-pointer">
                        </div>
                        <button @click="saveSettings" class="w-full bg-slate-800 text-white py-3 rounded font-bold hover:bg-slate-700">Save Changes</button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        function adminPanel() {
            return {
                tab: 'dash',
                uid: null,
                products: [],
                settings: { name: '', heroText: '', color: '#000000' },
                newProd: { name: '', price: '', image: 'https://via.placeholder.com/150' },
                storeLink: '',

                init() {
                    auth.onAuthStateChanged(user => {
                        if (!user) {
                            window.location.href = 'index.html';
                        } else {
                            this.uid = user.uid;
                            // Calculate store link based on current location
                            const baseUrl = window.location.href.substring(0, window.location.href.lastIndexOf('/'));
                            this.storeLink = `${baseUrl}/shop.html?id=${this.uid}`;
                            
                            this.loadData();
                        }
                    });
                },

                logout() { auth.signOut(); },

                async loadData() {
                    // Settings
                    const doc = await db.collection('agencies').doc(this.uid).get();
                    if(doc.exists && doc.data().storeSettings) {
                        this.settings = doc.data().storeSettings;
                    }
                    // Products
                    const snap = await db.collection('agencies').doc(this.uid).collection('products').get();
                    this.products = snap.docs.map(d => ({id: d.id, ...d.data()}));
                },

                async addProduct() {
                    if(!this.newProd.name) return;
                    await db.collection('agencies').doc(this.uid).collection('products').add(this.newProd);
                    this.newProd.name = ''; 
                    this.loadData();
                },

                async deleteProduct(id) {
                    if(confirm("Delete?")) {
                        await db.collection('agencies').doc(this.uid).collection('products').doc(id).delete();
                        this.loadData();
                    }
                },

                async saveSettings() {
                    await db.collection('agencies').doc(this.uid).update({ storeSettings: this.settings });
                    alert('Saved!');
                }
            }
        }
    </script>
</body>
</html>
