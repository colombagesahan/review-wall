<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgencyFlow - Platform Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body class="bg-gray-50 font-sans" x-data="authLogic()" x-init="initApp()">

    <nav class="bg-white shadow p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="text-2xl font-bold text-blue-600">AgencyFlow</div>
            <button @click="openLogin=true" class="bg-blue-600 text-white px-6 py-2 rounded-full font-bold">Login / Join</button>
        </div>
    </nav>

    <header class="text-center py-20 px-4">
        <div x-show="inviteAgencyName" class="mb-6 inline-block bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative">
            <strong class="font-bold">Special Invite!</strong>
            <span class="block sm:inline">You are joining <span x-text="inviteAgencyName" class="underline"></span>'s Team.</span>
        </div>

        <h1 class="text-5xl font-extrabold text-gray-900 mb-6">Launch Your Ecommerce Empire</h1>
        <p class="text-xl text-gray-600 mb-8">Whether you are an Agency or a Store Owner, we provide the tools to scale.</p>
        
        <button @click="openLogin=true" class="bg-gray-900 text-white px-8 py-4 rounded text-lg font-bold shadow-lg hover:bg-gray-800">
            <span x-show="inviteAgencyId">Create Client Account</span>
            <span x-show="!inviteAgencyId">Create Agency Account</span>
        </button>
    </header>

    <!-- Modal -->
    <div x-show="openLogin" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white p-8 rounded-lg shadow-2xl max-w-md w-full relative">
            <button @click="openLogin = false" class="absolute top-4 right-4 text-gray-400 text-xl">&times;</button>
            <h2 class="text-2xl font-bold mb-6 text-center">Platform Access</h2>
            <div x-show="error" class="bg-red-100 text-red-700 p-3 rounded mb-4 text-sm" x-text="error"></div>

            <input type="email" x-model="email" placeholder="Email" class="w-full border p-3 rounded mb-3">
            <input type="password" x-model="password" placeholder="Password" class="w-full border p-3 rounded mb-4">
            
            <button @click="handleAuth('login')" class="w-full bg-gray-200 text-gray-800 py-2 rounded font-bold mb-2">Login</button>
            <button @click="handleAuth('signup')" class="w-full bg-blue-600 text-white py-2 rounded font-bold">
                <span x-show="inviteAgencyId">Register as Client</span>
                <span x-show="!inviteAgencyId">Register as Agency</span>
            </button>
        </div>
    </div>

    <script>
        function authLogic() {
            return {
                openLogin: false,
                email: '', password: '', error: '',
                inviteAgencyId: null,
                inviteAgencyName: '',

                async initApp() {
                    const params = new URLSearchParams(window.location.search);
                    const ref = params.get('ref');
                    if (ref) {
                        this.inviteAgencyId = ref;
                        // Fetch Agency Name for better UX
                        const doc = await db.collection('agencies').doc(ref).get();
                        if(doc.exists) this.inviteAgencyName = doc.data().agencyName || "An Agency";
                        this.openLogin = true;
                    }
                },

                async handleAuth(action) {
                    this.error = '';
                    try {
                        if (action === 'signup') {
                            const cred = await auth.createUserWithEmailAndPassword(this.email, this.password);
                            if (this.inviteAgencyId) {
                                // REGISTER AS CLIENT
                                await db.collection('users').doc(cred.user.uid).set({
                                    email: this.email,
                                    parentAgency: this.inviteAgencyId,
                                    role: 'client',
                                    balance: 0,
                                    unpaidEarnings: 0,
                                    createdAt: new Date()
                                });
                                window.location.href = 'client-dashboard.html';
                            } else {
                                // REGISTER AS AGENCY
                                await db.collection('agencies').doc(cred.user.uid).set({
                                    email: this.email,
                                    role: 'agency',
                                    agencyName: 'My Agency',
                                    warningStatus: false, // For Super Admin Disputes
                                    createdAt: new Date()
                                });
                                window.location.href = 'agency-dashboard.html';
                            }
                        } else {
                            // LOGIN
                            const cred = await auth.signInWithEmailAndPassword(this.email, this.password);
                            const uid = cred.user.uid;
                            
                            // Check Super Admin
                            if(this.email === 'admin@admin.com') { window.location.href = 'super-admin.html'; return; }

                            // Check DB Roles
                            const agencyDoc = await db.collection('agencies').doc(uid).get();
                            if (agencyDoc.exists) { window.location.href = 'agency-dashboard.html'; return; }
                            
                            const userDoc = await db.collection('users').doc(uid).get();
                            if (userDoc.exists) { window.location.href = 'client-dashboard.html'; return; }
                        }
                    } catch (e) { this.error = e.message; }
                }
            }
        }
    </script>
</body>
</html>
