<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Store Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="firebase-config.js"></script>
</head>
<body class="bg-gray-100 font-sans" x-data="userStore()">

    <!-- Top Nav -->
    <nav class="bg-white shadow-sm sticky top-0 z-20">
        <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-store text-green-600 text-xl"></i>
                <span class="font-bold text-gray-800 text-lg">Store Builder</span>
            </div>
            <div class="flex items-center gap-4">
                <a :href="'shop.html?id=' + uid" target="_blank" class="text-blue-600 hover:underline text-sm font-medium">
                    <i class="fas fa-external-link-alt"></i> View Live Shop
                </a>
                <button @click="auth.signOut()" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded text-sm font-bold text-gray-700">Logout</button>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 py-8 grid grid-cols-1 md:grid-cols-3 gap-8">
        
        <!-- Left Column: Settings -->
        <div class="md:col-span-1 space-y-6">
            
            <!-- Store Settings Card -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h2 class="font-bold text-gray-800 mb-4 flex items-center gap-2"><i class="fas fa-paint-brush text-purple-500"></i> Design & Branding</h2>
                
                <div class="space-y-3">
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Store Name</label>
                        <input x-model="settings.name" class="w-full border p-2 rounded focus:ring-2 focus:ring-green-500 outline-none">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Headline Text</label>
                        <textarea x-model="settings.hero" class="w-full border p-2 rounded focus:ring-2 focus:ring-green-500 outline-none" rows="2"></textarea>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500 uppercase">Brand Color</label>
                        <div class="flex gap-2 mt-1">
                            <input type="color" x-model="settings.color" class="h-10 w-12 rounded cursor-pointer border">
                            <div class="flex-1 bg-gray-100 rounded flex items-center px-3 text-sm text-gray-600" x-text="settings.color"></div>
                        </div>
                    </div>
                </div>
                <button @click="saveSettings" class="w-full mt-4 bg-gray-900 text-white py-3 rounded-lg font-bold hover:bg-gray-800 transition">Save Changes</button>
            </div>

            <!-- Active Products Summary -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h2 class="font-bold text-gray-800 mb-2">My Inventory</h2>
                <p class="text-3xl font-bold text-green-600" x-text="myProducts.length">0</p>
                <p class="text-xs text-gray-400">Products live on your store</p>
            </div>
        </div>

        <!-- Right Column: Products -->
        <div class="md:col-span-2 space-y-6">
            
            <!-- Import Section -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h2 class="font-bold text-xl text-gray-800 mb-4">Product Marketplace</h2>
                <p class="text-sm text-gray-500 mb-6">Select products from your Agency to sell on your store. Set your own price to make a profit.</p>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 max-h-96 overflow-y-auto pr-2">
                    <template x-for="p in agencyCatalog">
                        <div class="border border-gray-100 rounded-lg p-3 hover:shadow-md transition bg-gray-50">
                            <div class="flex gap-4">
                                <img :src="p.image" class="w-16 h-16 rounded object-cover bg-white">
                                <div class="flex-1">
                                    <h4 class="font-bold text-sm text-gray-800 line-clamp-1" x-text="p.name"></h4>
                                    <p class="text-xs text-gray-500">Cost: $<span x-text="p.price"></span></p>
                                    
                                    <div class="mt-2 flex items-center gap-2">
                                        <div class="relative flex-1">
                                            <span class="absolute left-2 top-1 text-gray-400 text-xs">$</span>
                                            <input type="number" x-model="p.myPrice" class="w-full pl-5 py-1 text-sm border rounded">
                                        </div>
                                        <button @click="importProduct(p)" class="bg-green-600 text-white text-xs px-3 py-1.5 rounded font-bold hover:bg-green-700">Add</button>
                                    </div>
                                    <!-- Profit Preview -->
                                    <p class="text-[10px] text-right mt-1 text-green-600 font-bold">
                                        Profit: $<span x-text="(p.myPrice - p.price).toFixed(2)"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>

            <!-- Active List -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <h2 class="font-bold text-xl text-gray-800 mb-4">Active Products</h2>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-500 uppercase">
                            <tr>
                                <th class="p-3">Product</th>
                                <th class="p-3">Selling Price</th>
                                <th class="p-3 text-right">Action</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            <template x-for="p in myProducts">
                                <tr class="hover:bg-gray-50">
                                    <td class="p-3 font-medium flex items-center gap-2">
                                        <img :src="p.image" class="w-8 h-8 rounded">
                                        <span x-text="p.name"></span>
                                    </td>
                                    <td class="p-3 font-bold text-green-600" x-text="'$' + p.price"></td>
                                    <td class="p-3 text-right">
                                        <button @click="deleteProduct(p.id)" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        function userStore() {
            return {
                uid: null,
                agencyId: null,
                settings: {name:'My Store', hero:'Welcome', color:'#10B981'},
                agencyCatalog: [],
                myProducts: [],

                init() {
                    auth.onAuthStateChanged(async u => {
                        if(u) {
                            this.uid = u.uid;
                            const userDoc = await db.collection('users').doc(this.uid).get();
                            if(userDoc.exists) {
                                const data = userDoc.data();
                                this.agencyId = data.parentAgency;
                                if(data.settings) this.settings = data.settings;
                                this.loadData();
                            }
                        } else {
                            window.location.href = 'index.html';
                        }
                    });
                },

                async loadData() {
                    // Get Master Catalog
                    const cSnap = await db.collection('agencies').doc(this.agencyId).collection('master_catalog').get();
                    this.agencyCatalog = cSnap.docs.map(d => ({
                        ...d.data(), 
                        myPrice: d.data().price + 5 // Default Markup suggestion
                    }));

                    // Get My Products
                    const mSnap = await db.collection('users').doc(this.uid).collection('products').get();
                    this.myProducts = mSnap.docs.map(d => ({id: d.id, ...d.data()}));
                },

                async saveSettings() {
                    await db.collection('users').doc(this.uid).update({ settings: this.settings });
                    alert("Store design updated!");
                },

                async importProduct(p) {
                    await db.collection('users').doc(this.uid).collection('products').add({
                        name: p.name,
                        image: p.image,
                        price: parseFloat(p.myPrice)
                    });
                    this.loadData();
                },

                async deleteProduct(id) {
                    if(confirm("Remove from store?")) {
                        await db.collection('users').doc(this.uid).collection('products').doc(id).delete();
                        this.loadData();
                    }
                }
            }
        }
    </script>
</body>
</html>
